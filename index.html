<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PNR Pro - MOD DIAGNOSTIK</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    body { background: #f8fafc; font-family: sans-serif; font-size: 0.9rem; }
    #debugBox { background: #fee2e2; border: 2px solid #ef4444; color: #b91c1c; padding: 15px; margin: 20px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; display: none; }
    .chart-container { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    #map { height: 400px; width: 100%; }
  </style>
</head>
<body>

  <script>
    // ⚠️ PASTE URL WEB APP ANDA DI SINI
    const API_URL = "https://script.google.com/macros/s/AKfycbybYfIRU52AkFgk2wRXguK5Ja9DAjDkbwEy-zG3B8goc1c7UvbrrDhDli4hULaTJ1s/exec"; 
  </script>

  <div id="debugBox">
    <strong>[DEBUG MODE AKTIF]</strong><br>
    Sila tunggu data...<br>
  </div>

  <div class="container-fluid p-4">
    <div id="loginArea" class="card p-4 mx-auto shadow" style="max-width: 400px; margin-top: 50px;">
      <h4 class="text-center mb-3">Login PNR</h4>
      <input type="text" id="uid" class="form-control mb-2" placeholder="ID">
      <input type="password" id="pwd" class="form-control mb-3" placeholder="Password">
      <button onclick="doLogin()" class="btn btn-primary w-100">MASUK</button>
    </div>

    <div id="dashArea" style="display:none">
      <h3 class="mb-4">Dashboard PNR</h3>
      
      <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card p-3"><h5>Bancian</h5><h2 id="k1">0</h2></div></div>
        <div class="col-md-3"><div class="card p-3"><h5>Serangan</h5><h2 id="k2">0</h2></div></div>
      </div>

      <div class="row mb-4">
        <div class="col-md-8"><div class="chart-container"><canvas id="cBar"></canvas></div></div>
        <div class="col-md-4"><div class="chart-container"><canvas id="cPie"></canvas></div></div>
      </div>

      <div class="chart-container p-0"><div id="map"></div></div>

      <div class="chart-container mt-4">
        <table class="table table-sm"><thead class="table-light"><tr><th>Tarikh</th><th>Negeri</th><th>Lokasi</th><th>Tanaman</th><th>Luas(Ha)</th><th>Serangan(Ha)</th></tr></thead><tbody id="tBody"></tbody></table>
      </div>
    </div>
  </div>

  <script>
    // --- FUNGSI DEBUG ---
    function logError(msg, detail = "") {
        const d = document.getElementById('debugBox');
        d.style.display = 'block';
        d.innerHTML += `\n❌ <b>ERROR:</b> ${msg}\nDETAILS: ${JSON.stringify(detail)}\n`;
        console.error(msg, detail);
    }
    
    function logInfo(msg) {
        const d = document.getElementById('debugBox');
        d.style.display = 'block';
        d.innerHTML += `\n✅ ${msg}`;
        console.log(msg);
    }

    // --- SYSTEM LOGIC ---
    let mData = [], fData = [], uProf = null, map = null, charts = {};

    async function postData(action, payload) {
      try {
        const res = await fetch(`${API_URL}?action=${action}`, { 
            method: "POST", body: JSON.stringify({...payload, action}) 
        });
        return JSON.parse(await res.text());
      } catch (e) { logError("Gagal hubungi server", e); throw e; }
    }

    async function doLogin() {
        const u = document.getElementById('uid').value;
        const p = document.getElementById('pwd').value;
        logInfo("Sedang login...");
        
        try {
            const r = await postData('login', {u, p});
            if (r.success) {
                uProf = r;
                document.getElementById('loginArea').style.display = 'none';
                document.getElementById('dashArea').style.display = 'block';
                logInfo("Login berjaya. Memuatkan data...");
                initDash();
            } else {
                alert(r.message);
            }
        } catch (e) { logError("Login Crash", e.message); }
    }

    async function initDash() {
        try {
            // STEP 1: Tarik Data
            const d = await postData('getAnalytics', { state: uProf.state });
            
            if (!d.records) {
                logError("Data diterima tapi kosong/rosak.", d);
                return;
            }
            
            mData = d.records;
            fData = mData; // Bypass filter dulu untuk test
            logInfo(`Data diterima: ${mData.length} rekod.`);
            
            if(mData.length > 0) {
                logInfo("Contoh Data Pertama (Raw): " + JSON.stringify(mData[0]));
            }

            // STEP 2: Render KPI
            let tt = 0, ts = 0;
            fData.forEach(r => { tt += (r.lt || 0); ts += (r.ls || 0); });
            document.getElementById('k1').innerText = tt.toFixed(2);
            document.getElementById('k2').innerText = ts.toFixed(2);
            logInfo("KPI Berjaya dikira.");

            // STEP 3: Init Map (Biasa punca crash)
            try {
                if (!map) {
                    map = L.map('map').setView([4.2105, 101.9758], 6);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
                    logInfo("Peta asas berjaya dilukis.");
                }
                
                // Plot Points
                let pts = [];
                fData.forEach(d => {
                    if (d.c && typeof d.c === 'string' && d.c.includes(',')) {
                        let parts = d.c.split(',').map(n => parseFloat(n.trim())); // Extra safe parsing
                        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                            pts.push(parts);
                        }
                    }
                });
                
                if (pts.length > 0) {
                    pts.forEach(p => L.circleMarker(p, { radius: 5, color: 'red' }).addTo(map));
                    logInfo(`Peta: ${pts.length} titik diplot.`);
                } else {
                    logInfo("Peta: Tiada koordinat sah dijumpai.");
                }
            } catch (e) { logError("Peta Crash", e.message); }

            // STEP 4: Render Table
            try {
                const tbody = document.getElementById('tBody');
                tbody.innerHTML = fData.slice(0, 10).map(d => 
                    `<tr><td>${d.t||'-'}</td><td>${d.n||'-'}</td><td>${d.l||'-'}</td><td>${d.tn||'-'}</td><td>${(d.lt||0).toFixed(2)}</td><td>${(d.ls||0).toFixed(2)}</td></tr>`
                ).join('');
                logInfo("Jadual berjaya dipapar.");
            } catch (e) { logError("Jadual Crash", e.message); }

            // STEP 5: Charts (Bar & Pie)
            try {
                // Proses Data Chart
                let pm = {}, km = {1:0, 2:0, 3:0, 4:0, 5:0};
                fData.forEach(d => {
                    // Pest logic
                    if(d.p && typeof d.p === 'object') {
                        Object.entries(d.p).forEach(([k,v]) => pm[k] = (pm[k]||0) + (parseFloat(v)||0));
                    } else if (d.ls > 0) {
                        pm["Umum"] = (pm["Umum"]||0) + d.ls;
                    }
                    // Level logic
                    let l = parseInt(d.k) || 0;
                    if(l>0 && l<=5) km[l]++;
                });

                // Bar Chart
                const cBar = document.getElementById('cBar');
                new Chart(cBar, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(pm).length ? Object.keys(pm) : ['Tiada'],
                        datasets: [{ label: 'Ha', data: Object.values(pm).length ? Object.values(pm) : [0], backgroundColor: 'green' }]
                    }
                });
                
                // Pie Chart
                const cPie = document.getElementById('cPie');
                new Chart(cPie, {
                    type: 'doughnut',
                    data: {
                        labels: ['1','2','3','4','5'],
                        datasets: [{ data: Object.values(km), backgroundColor: ['green','lime','yellow','orange','red'] }]
                    }
                });
                
                logInfo("Carta berjaya dilukis.");

            } catch(e) { logError("Carta Crash", e.message); }

        } catch (e) {
            logError("CRASH UTAMA (INITDASH)", e.message);
        }
    }
  </script>
</body>
</html>
