<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem PNR Digital</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

    <style>
        :root { --primary: #064e3b; --accent: #10b981; --bg: #f3f4f6; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; margin:0; }
        
        /* LOGIN & LAYOUT */
        #loginOverlay { position: fixed; inset: 0; z-index: 999999; display: flex; align-items: center; justify-content: center; background: #064e3b; }
        .login-box { background: white; padding: 2.5rem; border-radius: 16px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .sidebar { width: 260px; height: 100vh; position: fixed; top: 0; left: 0; background: #e8f5e9; border-right: 1px solid #c6e7ce; padding: 20px; z-index: 100; transition: transform 0.3s; display: flex; flex-direction: column; }
        .brand { font-size: 1.3rem; font-weight: 900; color: #000; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; padding-left: 10px; flex-shrink: 0; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding-right: 5px; margin-bottom: 10px; }
        .sidebar-content::-webkit-scrollbar { width: 4px; }
        .sidebar-content::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: #000; font-weight: 600; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .nav-item:hover { background: #c8e6c9; color: #000; }
        .nav-item.active { background: #1b5e20; color: white; font-weight: 700; }
        .sidebar-footer { flex-shrink: 0; border-top: 1px solid #c6e7ce; padding-top: 15px; }
        .main-content { margin-left: 260px; padding: 25px; transition: margin-left 0.3s; }
        
        /* DASHBOARD CARDS */
        .kpi-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); border: 1px solid #e5e7eb; height: 100%; transition: transform 0.2s; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: #111827; margin-top: 5px; }
        .map-box { height: 400px; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb; position: relative; z-index: 1; }
        .table-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; overflow: hidden; }
        .text-danger { color: #dc2626 !important; }
        .badge-pending { background: #dc2626; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; display: none; }

        /* --- STYLE REPORT CARD (DIKEMASKINI) --- */
        .verify-card { background: #fff; border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; height: 100%; display: flex; flex-direction: column; transition: transform 0.2s; border: 1px solid #e2e8f0; }
        .verify-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .verify-header { background: #f8f9fa; border-bottom: 1px solid #e9ecef; padding: 15px 20px; display: flex; justify-content: space-between; align-items: flex-start; }
        .verify-body { padding: 20px; flex-grow: 1; }
        .verify-footer { background: #fff; border-top: 1px solid #e9ecef; padding: 15px; display: flex; gap: 10px; }
        
        .section-title { font-size: 0.8rem; font-weight: 800; text-transform: uppercase; color: var(--primary); margin: 15px 0 8px 0; border-bottom: 1px dashed #dee2e6; padding-bottom: 4px; display: flex; align-items: center; gap: 5px; }
        .section-title:first-child { margin-top: 0; }
        
        .v-row { display: flex; margin-bottom: 6px; font-size: 0.9rem; align-items: flex-start; border-bottom: 1px solid #f1f5f9; padding-bottom: 4px;}
        .v-label { width: 130px; font-weight: 700; color: #000; flex-shrink: 0; font-size: 0.85rem; }
        .v-val { flex-grow: 1; color: #1e293b; font-weight: 500; word-break: break-word; }
        
        /* TABLE MINI DALAM KAD (HEADER UPDATED) */
        .mini-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; margin-top: 5px; margin-bottom: 15px; }
        .mini-table th { background: #f1f5f9; text-transform: uppercase; font-size: 0.7rem; color: #475569; padding: 8px; border: 1px solid #e2e8f0; font-weight: 800; }
        .mini-table td { padding: 8px; border: 1px solid #e2e8f0; vertical-align: middle; }
        .mini-table td.center { text-align: center; }
        
        .syor-box { background-color: #fffbeb; border: 1px solid #fde68a; padding: 10px; border-radius: 6px; font-size: 0.85rem; color: #92400e; display: flex; gap: 8px; align-items: flex-start; }

        .filter-label { font-size: 0.75rem; font-weight: 800; color: #000; margin-bottom: 3px; display: block; text-transform: uppercase; }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <div class="brand justify-content-center mb-4"><i class="bi bi-flower1"></i> PNR DIGITAL</div>
            <h6 class="text-muted mb-4">Log Masuk Sistem</h6>
            <input type="text" id="uid" class="form-control mb-3 p-3" placeholder="ID Pengguna">
            <input type="password" id="pwd" class="form-control mb-4 p-3" placeholder="Kata Laluan">
            <button type="button" onclick="doLogin()" class="btn btn-success w-100 fw-bold p-3" id="btnLogin">MASUK</button>
            <small id="loginMsg" class="text-danger d-block mt-3 fw-bold"></small>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="brand"><i class="bi bi-flower1"></i> PNR DIGITAL</div>
        
        <div class="sidebar-content">
            <div class="nav-item active" onclick="switchTab('main', this)">
                <span><i class="bi bi-grid-1x2-fill me-2"></i> Dashboard</span>
            </div>
            <div class="nav-item" id="navVerify" style="display:none" onclick="switchTab('verify', this)">
                <span><i class="bi bi-check-circle-fill me-2"></i> Pengesahan</span>
                <span class="badge-pending" id="badgePending">0</span>
            </div>
            <hr class="my-4" style="color: #000;">
            
            <div class="mb-3 px-2">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <small class="fw-bold text-dark" style="font-size:0.85rem; letter-spacing: 0.5px;"><i class="bi bi-funnel-fill me-1"></i> TAPISAN DATA</small>
                </div>
                
                <div class="mb-2"><label class="filter-label">Negeri</label><select id="selNegeri" class="form-select form-select-sm" onchange="runFilter('n')"></select></div>
                <div class="mb-2"><label class="filter-label">Daerah</label><select id="selDaerah" class="form-select form-select-sm" onchange="runFilter('d')"></select></div>
                <div class="mb-2"><label class="filter-label">Tanaman</label><select id="selTanaman" class="form-select form-select-sm" onchange="runFilter('t')"></select></div>
                <div class="mb-2"><label class="filter-label">Perosak</label><select id="selPerosak" class="form-select form-select-sm" onchange="runFilter('p')"></select></div>
                <div class="mb-2"><label class="filter-label">Kategori</label><select id="selKategori" class="form-select form-select-sm" onchange="runFilter('k')"></select></div>
                
                <div class="mb-3">
                    <label class="filter-label">Julat Tarikh</label>
                    <div class="row g-1">
                        <div class="col-6"><input type="date" id="dS" class="form-control form-control-sm" onchange="runFilter()"></div>
                        <div class="col-6"><input type="date" id="dE" class="form-control form-control-sm" onchange="runFilter()"></div>
                    </div>
                </div>
                
                <button class="btn btn-dark btn-sm w-100" onclick="resetFilter()">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset Tapisan
                </button>

                <hr class="my-4" style="color:#000">

                <div class="p-3 rounded border shadow-sm bg-white">
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-danger text-white rounded p-1 me-2"><i class="bi bi-bug-fill"></i></div>
                        <small class="fw-bold text-dark" style="line-height:1.2">Pemantauan<br>Perangkap RPW</small>
                    </div>
                    <p class="text-muted mb-2" style="font-size: 0.75rem;">Akses pantas ke data perangkap kumbang.</p>
                    <button onclick="window.open(RPW_URL, '_blank')" class="btn btn-outline-danger btn-sm w-100 fw-bold">
                        <i class="bi bi-box-arrow-up-right"></i> Buka Sistem
                    </button>
                </div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <button onclick="window.open(BANCIAN_URL, '_blank')" class="btn btn-success w-100 btn-sm fw-bold mb-3 py-2 shadow-sm">
                <i class="bi bi-plus-lg me-1"></i> Tambah Data
            </button>
            <div class="d-flex align-items-center justify-content-between px-2">
                <div><small class="text-dark d-block" style="font-size: 0.75rem; font-weight:600;">Pengguna</small><strong id="uDisp" class="text-dark" style="font-size:0.9rem">-</strong></div>
                <button class="btn btn-link text-danger btn-sm p-0" onclick="doLogout()" title="Log Keluar"><i class="bi bi-box-arrow-right fs-5"></i></button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="d-md-none mb-3 d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm">
            <span class="fw-bold text-success fs-5"><i class="bi bi-flower1"></i> PNR</span>
            <button class="btn btn-light btn-sm border" onclick="document.getElementById('sidebar').classList.toggle('active')"><i class="bi bi-list fs-5"></i></button>
        </div>

        <div id="view-main">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                <div><h4 class="fw-bold m-0 text-dark">Analisis Data</h4><small class="text-muted" id="lastUpdate">Data setakat: Terkini</small></div>
                <div class="btn-group shadow-sm">
                    <button class="btn btn-white border bg-white text-secondary btn-sm px-3" onclick="initDash()"><i class="bi bi-arrow-clockwise"></i></button>
                    <button class="btn btn-success btn-sm px-3" onclick="downloadDualExcel()"><i class="bi bi-file-earmark-excel me-1"></i> Excel</button>
                    <button class="btn btn-danger btn-sm px-3" onclick="dlPDF()"><i class="bi bi-file-earmark-pdf me-1"></i> PDF</button>
                </div>
            </div>
            
            <div class="card mb-4 border-0 shadow-sm" style="background: linear-gradient(to right, #e0f2fe, #f0f9ff);">
                <div class="card-body p-4">
                    <div id="smartSummary" class="text-dark">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                            Sedang menganalisis data...
                        </div>
                    </div>
                </div>
            </div>


            <div class="row g-3 mb-4">
                <div class="col-6 col-md-3"><div class="kpi-card"><div class="d-flex justify-content-between mb-2"><span class="kpi-title">Luas Bancian</span><div class="kpi-icon bg-success-subtle text-success"><i class="bi bi-rulers"></i></div></div><div class="kpi-value" id="k1">0</div><small class="text-muted fw-bold">Hektar</small></div></div>
                <div class="col-6 col-md-3"><div class="kpi-card"><div class="d-flex justify-content-between mb-2"><span class="kpi-title">Luas Serangan</span><div class="kpi-icon bg-danger-subtle text-danger"><i class="bi bi-bug-fill"></i></div></div><div class="kpi-value text-danger" id="k2">0</div><small class="text-muted fw-bold">Hektar</small></div></div>
                <div class="col-6 col-md-3"><div class="kpi-card"><div class="d-flex justify-content-between mb-2"><span class="kpi-title">Peratus Serangan</span><div class="kpi-icon bg-warning-subtle text-warning"><i class="bi bi-percent"></i></div></div><div class="kpi-value" id="k3">0%</div><small class="text-muted fw-bold">Kadar Jangkitan</small></div></div>
                <div class="col-6 col-md-3"><div class="kpi-card"><div class="d-flex justify-content-between mb-2"><span class="kpi-title">Bil. Rekod</span><div class="kpi-icon bg-primary-subtle text-primary"><i class="bi bi-file-text"></i></div></div><div class="kpi-value" id="k4">0</div><small class="text-muted fw-bold">Unit Data</small></div></div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-8">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-header bg-transparent border-0 pt-4 px-4 pb-0"><h6 class="fw-bold text-secondary m-0">Carta Serangan Perosak Tertinggi (Ha)</h6></div>
                        <div class="card-body px-4 pb-4"><div style="height: 350px"> <canvas id="cBar"></canvas> </div></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-header bg-transparent border-0 py-3 d-flex align-items-center px-4 pt-4">
                            <div class="icon-shape bg-warning text-white rounded-3 p-2 me-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="bi bi-pie-chart-fill"></i></div>
                            <h6 class="m-0 fw-bold text-secondary">Tahap Keterukan</h6>
                        </div>
                        <div class="card-body text-center position-relative px-4 pb-4">
                            <div style="height: 250px;"><canvas id="cPie"></canvas></div>
                            <div class="mt-4 pt-3 border-top">
                                <p class="text-uppercase text-muted fw-bold mb-2" style="font-size: 10px; letter-spacing: 1px;">Petunjuk Tahap</p>
                                <div class="d-flex flex-wrap justify-content-center gap-2" style="font-size: 11px;">
                                    <span class="badge rounded-pill bg-success bg-opacity-75 text-white">T1: Sgt Rendah</span>
                                    <span class="badge rounded-pill bg-info text-dark">T2: Rendah</span>
                                    <span class="badge rounded-pill bg-warning text-dark">T3: Sederhana</span>
                                    <span class="badge rounded-pill text-white" style="background-color: #fd7e14;">T4: Teruk</span>
                                    <span class="badge rounded-pill bg-danger text-white">T5: Sgt Teruk</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-8"><div class="map-box shadow-sm" id="map"></div></div>
                <div class="col-md-4">
                    <div class="table-box h-100 shadow-sm" style="max-height:400px; overflow-y:auto">
                        <h6 class="fw-bold mb-3 text-danger d-flex align-items-center"><i class="bi bi-fire me-2"></i>Hotspot Daerah</h6>
                        <table class="table table-hover small mb-0"><thead class="table-light sticky-top"><tr><th>Daerah</th><th class="text-end">Luas Serangan (Ha)</th></tr></thead><tbody id="hotspotTable"></tbody></table>
                    </div>
                </div>
            </div>

            <div class="table-box shadow-sm">
                <div class="d-flex justify-content-between mb-3"><h6 class="fw-bold"><i class="bi bi-table me-2"></i>Jadual Rekod</h6><small id="pgInfo" class="text-muted"></small></div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead class="table-light"><tr><th>Tarikh</th><th>Negeri</th><th>Lokasi</th><th>Tanaman</th><th>Luas Bancian</th><th>Luas Serangan</th></tr></thead>
                        <tbody id="tBody"></tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-2">
                    <button class="btn btn-sm btn-white border shadow-sm px-3" onclick="movePg(-1)">Prev</button>
                    <button class="btn btn-sm btn-white border shadow-sm px-3" onclick="movePg(1)">Next</button>
                </div>
            </div>
        </div>

        <div id="view-verify" style="display:none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold m-0 text-dark">Pengesahan Data</h4>
                <div class="btn-group shadow-sm">
                    <button class="btn btn-success btn-sm px-3 fw-bold" onclick="approveAll()"><i class="bi bi-check-all me-1"></i> Sahkan Semua</button>
                    <button class="btn btn-primary btn-sm px-3" onclick="loadPend()"><i class="bi bi-arrow-clockwise me-1"></i> Refresh</button>
                </div>
            </div>
            
            <div id="bulkProgress" class="alert alert-info" style="display:none">
                <div class="d-flex justify-content-between mb-1"><small>Memproses...</small><small id="progText">0%</small></div>
                <div class="progress" style="height: 10px;"><div class="progress-bar bg-success" id="progBar" style="width: 0%"></div></div>
            </div>
            
            <div id="verifyContainer" class="row g-3">
                <div class="col-12 text-center p-5 text-muted bg-white rounded shadow-sm border border-dashed">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">Memuatkan senarai untuk disahkan...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-success text-white">
                    <h6 class="modal-title fw-bold"><i class="bi bi-card-heading me-2"></i>BUTIRAN REKOD DISAHKAN</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light p-4" id="detailBody">
                    </div>
                <div class="modal-footer bg-white">
                    <button type="button" class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // *** GANTI DENGAN URL API BARU DARI AKAUN GMAIL PERSONAL ANDA ***
        const API_URL = "https://script.google.com/macros/s/AKfycbyKB5-TBuZ8JXs1pz9s7LBCT5stsFaNP8fMzw8UvbPYbKCWuus8mSuDdaLFaK1PNDG8/exec";
        const BANCIAN_URL = "https://script.google.com/macros/s/AKfycbwmlorXpSkvDx_PJT4eRYcWc0MGii7nyeafpSIDPdD-z_At1hY8leUzFyvAKy5kLrrA/exec";
        const RPW_URL = "https://www.appsheet.com/start/55b088df-3ec1-469a-b5c6-1fca48052906";
        
        let mData=[], fData=[], uProf=null, charts={}, map=null, layer=null, pg=1, pSize=10;
        let currentPendingRows = []; 
        let userToken = ""; 
        let currentUserID = "";

        // --- FUNGSI POST DATA (FIXED: ELAK ERROR toLowerCase) ---
        async function postData(act, load) {
            try {
                let payload;
                if (act === 'login') { 
                    payload = { action: act, ...load }; 
                } else { 
                    payload = { action: act, token: userToken, u: currentUserID, ...load }; 
                }
                
                const res = await fetch(`${API_URL}?action=${act}`, { 
                    method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(payload) 
                });
                
                const r = JSON.parse(await res.text());

                // --- SECURITY KILL SWITCH (DIBETULKAN) ---
                // Periksa: Jika GAGAL, dan ADA MESEJ, baru semak isi mesejnya.
                if (r.success === false && r.message) {
                    // Kita tukar jadi string dulu baru lowercase, untuk elak error 'undefined'
                    const msgToCheck = String(r.message).toLowerCase();
                    
                    if (msgToCheck.includes("sesi") || msgToCheck.includes("token")) {
                        alert("⛔ " + r.message + "\n\nSila log masuk semula.");
                        // Clear Session
                        localStorage.removeItem('pnr_session');
                        location.reload(); 
                        return { success: false }; 
                    }
                }

                return r;

            } catch(e) { 
                console.error(e); 
                return {success:false, message:"Ralat sambungan."}; 
            }
        }

        async function doLogin() {
            const u = document.getElementById('uid').value; 
            const p = document.getElementById('pwd').value; 
            const btn = document.getElementById('btnLogin'); 
            const msg = document.getElementById('loginMsg');
            
            if(!u || !p) { msg.innerText = "Sila isi ID dan Kata Laluan"; return; }
            
            btn.disabled = true; btn.innerText = "Memproses...";
            
            const r = await postData('login', {u, p});
            
            if(r.success) {
                // --- SIMPAN SESSION (BARU) ---
                const sessionData = { 
                    uProf: r, 
                    userToken: r.token, 
                    currentUserID: u 
                };
                localStorage.setItem('pnr_session', JSON.stringify(sessionData));
                
                applyLogin(r, r.token, u);

            } else { 
                msg.innerText = r.message; 
                btn.disabled = false; 
                btn.innerText = "MASUK"; 
            }
        }

        // --- FUNGSI BANTUAN SET UI (UNTUK LOGIN & AUTO-LOGIN) ---
        function applyLogin(r, token, uid) {
            uProf = r; 
            userToken = token; 
            currentUserID = uid;
            
            document.getElementById('uDisp').innerText = r.name; 
            document.getElementById('loginOverlay').style.display = 'none';
            
            if(["ADMIN","PENYELIA"].includes((r.role||"").toUpperCase())) { 
                document.getElementById('navVerify').style.display = "flex"; 
                checkPendingCount(); 
            }
            
            initDash();
        }

     // --- FUNGSI AUTO-LOGIN (DENGAN REKOD MASA) ---
function checkSession() {
    const saved = localStorage.getItem('pnr_session');
    if (saved) {
        try {
            const s = JSON.parse(saved);
            
            // Masukkan balik data ke dalam variable dan UI
            if (s.uProf && s.userToken) {
                // 1. Pulihkan paparan
                applyLogin(s.uProf, s.userToken, s.currentUserID);
                
                // 2. HANTAR PING KE BACKEND UNTUK REKOD MASA (BARU)
                // Kita buat secara 'senyap' (tak perlu await response)
                postData('logSession', { 
                    name: s.uProf.name, 
                    role: s.uProf.role 
                });
                
                console.log("Sesi dipulihkan & direkod untuk: " + s.uProf.name);
            }
        } catch (e) {
            console.error("Gagal baca session", e);
        }
    }
}

        // --- FUNGSI LOGOUT ---
        function doLogout() {
            localStorage.removeItem('pnr_session'); // Padam ingatan
            location.reload(); // Refresh page
        }

        // JALANKAN CHECK SESSION SEBAIK SAHAJA PAGE LOAD
        window.onload = checkSession;

        function switchTab(t, el) {
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active')); if(el) el.classList.add('active');
            document.getElementById('view-main').style.display = t==='main'?'block':'none';
            document.getElementById('view-verify').style.display = t==='verify'?'block':'none';
            if(t==='verify') loadPend();
            if(t==='main' && map) setTimeout(() => map.invalidateSize(), 300);
        }

        async function checkPendingCount() { try { const d = await postData('getPending', {state: uProf.state}); const b = document.getElementById('badgePending'); if(d.rows && d.rows.length > 0) { b.innerText = d.rows.length; b.style.display = "inline-block"; } else { b.style.display = "none"; } } catch(e){} }

        async function initDash() {
            document.getElementById('smartSummary').innerHTML = '<span class="text-primary"><i class="bi bi-arrow-clockwise fa-spin"></i> Sedang mengemaskini data...</span>';
            const d = await postData('getAnalytics', {state: uProf.state}); 
            if(!d.records) { alert(d.message || "Tiada Data"); document.getElementById('smartSummary').innerHTML = "Tiada data."; return; }
            mData = d.records; 
            
            const currentN = document.getElementById('selNegeri').value;
            fillSel('selNegeri', mData.map(d => d.n).filter((v, i, a) => a.indexOf(v) === i).sort()); 
            if(currentN) document.getElementById('selNegeri').value = currentN;
            
            if(uProf.state !== "ALL") { 
                const s = document.getElementById('selNegeri'); 
                s.value = uProf.state; s.disabled = true; 
            }
            if(!map) { map = L.map('map').setView([4.2105, 101.9758], 6); L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map); }
            
            runFilter('n');
        }

        function runFilter(source) {
            const n=v('selNegeri'), d=v('selDaerah'), t=v('selTanaman'), p=v('selPerosak'), k=v('selKategori'), s=v('dS'), e=v('dE');

            fData = mData.filter(r => { 
                let pestOk = true;
                if(p && r.p) { try{ pestOk = (typeof r.p==='string'?JSON.parse(r.p):r.p)[p] }catch(err){ pestOk=false } }
                return (n===""||r.n===n) && (d===""||r.d===d) && (t===""||r.tn===t) && (k===""||r.kt===k) && pestOk && (!s||r.t>=s) && (!e||r.t<=e);
            });

            if(source === 'n' || !source) {
                const dataD = mData.filter(r => n === "" || r.n === n);
                updateDropdown('selDaerah', [...new Set(dataD.map(x=>x.d).filter(x=>x))].sort(), d);
            }
            if(source === 'd' || source === 'n' || !source) {
                const dataT = mData.filter(r => (n===""||r.n===n) && (d===""||r.d===d));
                updateDropdown('selTanaman', [...new Set(dataT.map(x=>x.tn).filter(x=>x))].sort(), t);
            }
            if(source === 't' || source === 'd' || source === 'n' || !source) {
                const dataRest = mData.filter(r => (n===""||r.n===n) && (d===""||r.d===d) && (t===""||r.tn===t));
                updateDropdown('selKategori', [...new Set(dataRest.map(x=>x.kt).filter(x=>x))].sort(), k);
                let allPests = new Set();
                dataRest.forEach(r => { try{ let obj=typeof r.p==='string'?JSON.parse(r.p):r.p; if(obj) Object.keys(obj).forEach(x=>allPests.add(x)) }catch(e){} });
                updateDropdown('selPerosak', [...allPests].sort(), p);
            }

            pg = 1; calcUI();
        }

        function updateDropdown(id, list, curVal) {
            const el = document.getElementById(id); el.innerHTML = '<option value="">Semua</option>';
            list.forEach(x => { let opt=document.createElement('option'); opt.value=x; opt.innerText=x; el.appendChild(opt); });
            if(list.includes(curVal)) el.value = curVal; else el.value = "";
        }
        function v(id){ return document.getElementById(id).value; }
        function fillSel(id, arr) { updateDropdown(id, arr, ""); }
        function resetFilter(){ document.querySelectorAll('select:not(:disabled), input[type=date]').forEach(e=>e.value=""); runFilter('n'); }

        function calcUI() {
            let tt=0, ts=0, pm={}, km={1:0,2:0,3:0,4:0,5:0}, pts=[], hData={};
            fData.forEach(d => {
                tt += (d.lt||0); ts += (d.ls||0);
                try{ let p=typeof d.p==='string'?JSON.parse(d.p):d.p; if(p) Object.entries(p).forEach(([k,v])=>pm[k]=(pm[k]||0)+parseFloat(v)); else if(d.ls>0) pm["Umum"]=(pm["Umum"]||0)+d.ls; }catch(e){ if(d.ls>0) pm["Umum"]=(pm["Umum"]||0)+d.ls; }
                let l = parseInt(d.k)||0; if(l>0 && l<=5) km[l]++;
                if(d.c && d.c.includes(',')) { let p = d.c.split(',').map(Number); if(p.length===2 && !isNaN(p[0])) pts.push(p); }
                if(d.ls > 0 && d.d !== "-") hData[d.d] = (hData[d.d]||0) + d.ls;
            });
            document.getElementById('k1').innerText = tt.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('k2').innerText = ts.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('k3').innerText = tt>0 ? ((ts/tt)*100).toFixed(1)+"%" : "0%";
            document.getElementById('k4').innerText = fData.length.toLocaleString('en-US');
            updateCharts(pm, km); updateMap(pts); updateHotspot(hData); genSummary(pm, tt, ts); renTab();
        }

        /* --- ANALISIS PINTAR (WARNA IKUT CHART) --- */
        function genSummary(pm, tt, ts) {
            const el = document.getElementById('smartSummary');
            if (!el) return;

            // 1. Jika Tiada Data
            if (ts === 0 || fData.length === 0) {
                el.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="bg-light rounded-circle p-3 me-3 text-secondary"><i class="bi bi-robot fs-2"></i></div>
                    <div><h6 class="text-primary fw-bold mb-1">Analisis Pintar</h6><span class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Tiada rekod serangan dilaporkan setakat ini.</span></div>
                </div>`;
                return;
            }

            // 2. Logic Cari Hotspot
            let locGroups = {};
            fData.forEach(d => {
                const locKey = d.l; 
                const ls = parseFloat(d.ls) || 0;
                const lt = parseFloat(d.lt) || 0;

                if (ls > 0) {
                    if (!locGroups[locKey]) {
                        locGroups[locKey] = {
                            name: locKey,
                            negeri: d.n,
                            daerah: d.d,
                            totalLS: 0,
                            totalLT: 0,
                            crops: {},
                            pests: {},
                            severitySum: 0,
                            count: 0
                        };
                    }
                    let g = locGroups[locKey];
                    g.totalLS += ls;
                    g.totalLT += lt; 
                    g.count++;
                    g.severitySum += (parseInt(d.k) || 0);
                    g.crops[d.tn] = (g.crops[d.tn] || 0) + ls;
                    
                    try {
                        let pObj = typeof d.p === 'string' ? JSON.parse(d.p) : d.p;
                        if (pObj) Object.entries(pObj).forEach(([pN, pA]) => g.pests[pN] = (g.pests[pN] || 0) + (parseFloat(pA)||0));
                    } catch (e) {}
                }
            });

            // 3. Cari Juara
            const sortedLocs = Object.values(locGroups).sort((a, b) => b.totalLS - a.totalLS);
            
            if (sortedLocs.length === 0) { el.innerHTML = "Data tidak mencukupi."; return; }

            const topLoc = sortedLocs[0];

            // 4. Cari Top Crop & Pest
            const topCropEntry = Object.entries(topLoc.crops).sort((a,b) => b[1] - a[1])[0];
            const topCrop = topCropEntry ? topCropEntry[0] : "Tanaman";

            const topPestEntry = Object.entries(topLoc.pests).sort((a,b) => b[1] - a[1])[0];
            const topPest = topPestEntry ? topPestEntry[0] : "Perosak";

            // 5. Kira Index & Peratus
            const avgSev = topLoc.count > 0 ? (topLoc.severitySum / topLoc.count).toFixed(1) : "0.0";
            let score = parseFloat(avgSev);
            
            // --- LOGIK WARNA (IKUT CHART KETERUKAN) ---
            let sevText = "Rendah";
            let sevColor = "#22c55e"; // T1 (Hijau) - Default

            if (score >= 4.5) {
                sevText = "Sangat Teruk";
                sevColor = "#ef4444"; // T5 (Merah)
            } else if (score >= 4.0) {
                sevText = "Teruk";
                sevColor = "#f97316"; // T4 (Oren)
            } else if (score >= 3.0) {
                sevText = "Sederhana";
                sevColor = "#eab308"; // T3 (Kuning)
            } else if (score >= 2.0) {
                sevText = "Rendah";
                sevColor = "#84cc16"; // T2 (Lime)
            }

            let locPct = topLoc.totalLT > 0 ? ((topLoc.totalLS / topLoc.totalLT) * 100).toFixed(2) : "0.00";

            // 6. Generate HTML
            el.innerHTML = `
            <div class="d-flex align-items-start">
                <div class="d-none d-sm-flex bg-white shadow-sm border rounded-circle p-3 me-4 align-items-center justify-content-center" style="width: 60px; height: 60px; flex-shrink: 0;">
                    <i class="bi bi-robot fs-3 text-primary"></i>
                </div>

                <div style="flex-grow: 1;">
                    <h6 class="text-primary fw-bold mb-3">Analisis Pintar</h6>
                    
                    <div class="mb-2" style="font-size: 0.95rem;">
                        <i class="bi bi-geo-alt-fill text-danger me-2"></i> 
                        Lokasi Hotspot: <b class="text-uppercase text-dark">${topLoc.daerah}, ${topLoc.negeri}</b>
                    </div>

                    <div class="mb-2" style="font-size: 0.95rem; line-height: 1.5;">
                        <i class="bi bi-flower1 text-success me-2"></i> 
                        Tanaman <b class="text-uppercase text-dark">${topCrop}</b> paling terkesan akibat serangan <b class="text-uppercase text-dark">${topPest}</b>
                    </div>

                    <div class="mb-2" style="font-size: 0.95rem;">
                        <i class="bi bi-exclamation-circle-fill text-warning me-2"></i> 
                        Luas Serangan: <b class="text-dark">${topLoc.totalLS.toFixed(2)} Ha</b> 
                        <span class="text-muted">(${locPct}%)</span>
                    </div>

                    <div style="font-size: 0.95rem;">
                        <i class="bi bi-bar-chart-fill me-2" style="color: ${sevColor}"></i> 
                        Indeks Keterukan: <b class="text-dark">${avgSev}</b> - <span style="color: ${sevColor}; font-weight: bold;">${sevText}</span>
                    </div>
                </div>
            </div>
            `;
        }

        function updateCharts(pm, km) { const tp = Object.entries(pm).sort((a,b)=>b[1]-a[1]).slice(0,10); if(charts.b) charts.b.destroy(); charts.b = new Chart(document.getElementById('cBar'), { type: 'bar', data: { labels: tp.map(x=>x[0]), datasets: [{ label: 'Ha', data: tp.map(x=>x[1]), backgroundColor: '#10b981', borderRadius:4 }] }, options: { indexAxis: 'y', maintainAspectRatio: false, plugins:{legend:{display:false}} } }); if(charts.p) charts.p.destroy(); charts.p = new Chart(document.getElementById('cPie'), { type: 'doughnut', data: { labels: ['T1','T2','T3','T4','T5'], datasets: [{ data: Object.values(km), backgroundColor: ['#22c55e','#84cc16','#eab308','#f97316','#ef4444'], borderWidth:0 }] }, options: { maintainAspectRatio: false, plugins:{legend:{position:'right'}} } }); }
        function updateMap(pts) { if(layer) map.removeLayer(layer); if(pts.length) { layer = L.layerGroup(pts.map(p => L.circleMarker(p, {radius:6, color:'#dc2626', fillOpacity:0.7, stroke:true, weight:1, color:'white', fillColor:'#dc2626'}))).addTo(map); map.fitBounds(L.latLngBounds(pts)); } }
        function updateHotspot(hData) { const s = Object.entries(hData).sort((a,b)=>b[1]-a[1]).slice(0,5); document.getElementById('hotspotTable').innerHTML = s.length ? s.map(x=>`<tr><td>${x[0]}</td><td class="text-end fw-bold text-danger">${x[1].toFixed(2)}</td></tr>`).join('') : '<tr><td colspan="2" class="text-center text-muted">Tiada Data</td></tr>'; }
        
        // --- 1. FUNCTION RENTAB (DIKEMASKINI DENGAN KLIK ROW) ---
        function renTab() { 
            const st = (pg-1)*pSize; 
            const dt = fData.slice(st, st+pSize); 
            
            document.getElementById('tBody').innerHTML = dt.length ? dt.map((d, i) => {
                // Kita hantar index sebenar dalam array fData
                const realIndex = st + i;
                return `
                <tr onclick="viewRec(${realIndex})" style="cursor: pointer;" title="Klik untuk lihat butiran">
                    <td>${d.t}</td>
                    <td>${d.n}</td>
                    <td>${d.l}</td>
                    <td><span class="badge bg-light text-dark border">${d.tn}</span></td>
                    <td>${d.lt.toFixed(2)}</td>
                    <td class="text-danger fw-bold">${d.ls.toFixed(2)}</td>
                </tr>`;
            }).join('') : '<tr><td colspan="6" class="text-center text-muted p-4">Tiada rekod.</td></tr>'; 
            
            document.getElementById('pgInfo').innerText = `Page ${pg}`; 
        }        

      // --- FUNCTION VIEWREC (FULL EDIT MODE) ---
function viewRec(idx) {
    const d = fData[idx];
    if (!d) return;

    const cleanImg = (raw) => {
        if (!raw) return [];
        let str = String(raw).trim().replace(/[\[\]"'\\]/g, '');
        return str.split(',').map(l => l.trim()).filter(l => l.toLowerCase().startsWith('http'));
    };

    let pestRows = "";
    if (d.p && Object.keys(d.p).length > 0) {
        Object.keys(d.p).forEach(k => {
            let luasVal = d.p[k], pctVal = (d.pp && d.pp[k]) ? d.pp[k] : 0, sevVal = (d.pk && d.pk[k]) ? d.pk[k] : 0, level = parseInt(sevVal) || 0;
            let badgeColor = level < 3 ? 'success' : (level < 4 ? 'warning' : 'danger');
            pestRows += `<tr><td style="font-size:0.85rem" class="text-uppercase">${k}</td><td class="text-center fw-bold">${parseFloat(luasVal).toFixed(2)}</td><td class="text-center small">${pctVal}%</td><td class="text-center"><span class="badge bg-${badgeColor}">T${level}</span></td></tr>`;
        });
    } else { pestRows = `<tr><td colspan="4" class="text-center text-muted small">Tiada Data Terperinci</td></tr>`; }

    const imgLinks = cleanImg(d.im);
    let imgHTML = imgLinks.length > 0 ? `<div class="mt-3 pt-2 border-top"><h6 class="fw-bold text-secondary small mb-2 text-uppercase"><i class="bi bi-paperclip me-1"></i> LAMPIRAN GAMBAR</h6><div class="d-flex flex-wrap gap-2">` + imgLinks.map((lnk,i)=>`<a href="${lnk}" target="_blank" class="btn btn-sm btn-outline-primary bg-white shadow-sm text-truncate fw-bold" style="max-width:140px;"><i class="bi bi-image me-1"></i> Gambar ${i+1}</a>`).join('') + `</div></div>` : `<div class="mt-3 pt-2 border-top"><small class="text-muted fst-italic text-uppercase"><i class="bi bi-slash-circle me-1"></i> TIADA GAMBAR</small></div>`;

    // ADMIN BUTTONS
    let adminBtns = "";
    if (uProf.role === "ADMIN") {
        adminBtns = `<div class="border-top pt-3 mt-3 d-flex justify-content-between gap-2"><button onclick="enableEditMode(${d.id})" class="btn btn-outline-primary btn-sm flex-grow-1"><i class="bi bi-pencil-square me-1"></i> KEMASKINI</button><button onclick="doDeleteRec(${d.id})" class="btn btn-outline-danger btn-sm flex-grow-1"><i class="bi bi-trash-fill me-1"></i> PADAM</button></div>`;
    }

    // --- FORM HTML ---
    const html = `
    <div class="verify-card bg-white rounded-3 shadow-sm border h-100 position-relative">
        <div class="p-3 border-bottom bg-light d-flex justify-content-between align-items-start">
            <div>
                <div class="small text-muted mb-1"><i class="bi bi-calendar3 me-1"></i> ${d.t}</div>
                <div class="fw-bold text-uppercase text-dark">${d.pg}</div>
                <div class="small text-muted fst-italic">${d.em}</div>
            </div>
            <span class="badge bg-success text-white shadow-sm">DISAHKAN</span>
        </div>

        <div class="p-3 pb-0">
            <div id="view_info_${d.id}">
                <h6 class="fw-bold text-success mb-3 small border-bottom pb-2 text-uppercase"><i class="bi bi-info-circle-fill me-1"></i> LOKASI & TANAMAN</h6>
                <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">NEGERI:</div><div class="col-8 fw-bold text-dark">${d.n}</div></div>
                <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">DAERAH:</div><div class="col-8 fw-bold text-dark">${d.d}</div></div>
                <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">LOKASI:</div><div class="col-8 fw-bold text-dark">${d.l}</div></div>
                <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">KOORDINAT:</div><div class="col-8 font-monospace text-muted small">${d.c}</div></div>
                <hr class="my-2 text-muted opacity-25">
                <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">TANAMAN:</div><div class="col-8 fw-bold text-success">${d.tn}</div></div>
                <div class="row g-2 mb-1" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">VARIETI:</div><div class="col-8 text-uppercase">${d.vr}</div></div>
                <div class="row g-2 mb-3" style="font-size:0.9rem"><div class="col-4 fw-bold text-secondary">LUAS TANAMAN:</div><div class="col-8 text-dark">${d.lt.toFixed(2)} HA</div></div>
            </div>

            <div id="edit_mode_${d.id}" style="display:none;" class="bg-light p-3 rounded border mb-3">
                <h6 class="fw-bold text-primary mb-3 small border-bottom pb-2"><i class="bi bi-pencil-fill me-1"></i> MOD PENYUNTINGAN</h6>
                
                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small fw-bold">Tarikh</label><input type="date" id="ed_date_${d.id}" class="form-control form-control-sm" value="${d.t}"></div>
                    <div class="col-6"><label class="small fw-bold">Pegawai</label><input type="text" id="ed_name_${d.id}" class="form-control form-control-sm" value="${d.pg}"></div>
                </div>
                
                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small fw-bold">Negeri</label><input type="text" id="ed_state_${d.id}" class="form-control form-control-sm" value="${d.n}"></div>
                    <div class="col-6"><label class="small fw-bold">Daerah</label><input type="text" id="ed_dist_${d.id}" class="form-control form-control-sm" value="${d.d}"></div>
                </div>

                <div class="mb-2"><label class="small fw-bold">Lokasi/Kebun</label><input type="text" id="ed_loc_${d.id}" class="form-control form-control-sm" value="${d.l}"></div>
                <div class="mb-2"><label class="small fw-bold">Koordinat</label><input type="text" id="ed_coord_${d.id}" class="form-control form-control-sm" value="${d.c}"></div>

                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small fw-bold">Tanaman</label><input type="text" id="ed_crop_${d.id}" class="form-control form-control-sm" value="${d.tn}"></div>
                    <div class="col-6"><label class="small fw-bold">Varieti</label><input type="text" id="ed_var_${d.id}" class="form-control form-control-sm" value="${d.vr}"></div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small fw-bold">Luas Tanam(Ha)</label><input type="number" id="ed_lt_${d.id}" class="form-control form-control-sm" value="${d.lt}"></div>
                    <div class="col-6"><label class="small fw-bold">Luas Serang(Ha)</label><input type="number" id="ed_ls_${d.id}" class="form-control form-control-sm" value="${d.ls}"></div>
                </div>

                <div class="mb-3"><label class="small fw-bold">Syor Kawalan</label><textarea id="ed_syor_${d.id}" class="form-control form-control-sm" rows="2">${d.s}</textarea></div>

                <div class="d-flex gap-2">
                    <button onclick="cancelEdit(${d.id})" class="btn btn-secondary btn-sm flex-grow-1">Batal</button>
                    <button onclick="saveEdit(${d.id})" class="btn btn-success btn-sm flex-grow-1">Simpan Perubahan</button>
                </div>
            </div>
        </div>

        <div class="px-3" id="view_pest_${d.id}">
            <h6 class="fw-bold text-success mb-2 small text-uppercase"><i class="bi bi-bug-fill me-1"></i> DATA SERANGAN</h6>
            <div class="table-responsive border rounded mb-2">
                <table class="table table-sm table-striped mb-0" style="font-size:0.8rem">
                    <thead class="table-light"><tr><th>PEROSAK</th><th class="text-center">LUAS SERANGAN (HA)</th><th class="text-center">PERATUS SERANGAN</th><th class="text-center">KETERUKAN SERANGAN</th></tr></thead>
                    <tbody>${pestRows}</tbody>
                </table>
            </div>
            <div class="alert alert-warning border-warning mb-0 py-2 px-3 small">
                <i class="bi bi-lightbulb-fill text-warning me-1"></i> <strong>SYOR:</strong> ${d.s}
            </div>
            ${imgHTML}
        </div>

        <div class="p-3 mt-auto">
            <div class="bg-success bg-opacity-10 border border-success rounded p-2 text-center">
                <small class="text-success fw-bold text-uppercase mb-1 d-block">DISAHKAN OLEH:</small>
                <div class="text-dark small fw-bold">${d.vb}</div>
            </div>
            ${adminBtns}
        </div>
    </div>`;

    document.getElementById('detailBody').innerHTML = html;
    new bootstrap.Modal(document.getElementById('detailModal')).show();
}

function enableEditMode(id) {
    document.getElementById(`view_info_${id}`).style.display = 'none';
    document.getElementById(`view_pest_${id}`).style.display = 'none'; // Sembunyi detail pest masa edit untuk jimat ruang
    document.getElementById(`edit_mode_${id}`).style.display = 'block';
}

function cancelEdit(id) {
    document.getElementById(`view_info_${id}`).style.display = 'block';
    document.getElementById(`view_pest_${id}`).style.display = 'block';
    document.getElementById(`edit_mode_${id}`).style.display = 'none';
}
        
async function doDeleteRec(rowID) {
    if(!confirm("⚠️ AMARAN: Adakah anda pasti mahu memadam rekod ini?\n\nData akan dipindahkan ke arkib 'Data_dipadam'.")) return;
    
    // UI Loading (Guna closest supaya tak tersilap target ikon)
    const btn = event.target.closest('button'); 
    const oriText = btn ? btn.innerHTML : "PADAM";
    
    if (btn) {
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memadam...';
        btn.disabled = true;
    }

    try {
        const r = await postData('deleteEntry', { row: rowID });
        
        if(r.success) {
            alert("✅ " + r.message);
            location.reload(); 
        } else {
            alert("❌ " + r.message);
            if (btn) {
                btn.innerHTML = oriText;
                btn.disabled = false;
            }
        }
    } catch (e) {
        console.error(e);
        alert("❌ Ralat sistem.");
        if (btn) {
            btn.innerHTML = oriText;
            btn.disabled = false;
        }
    }
}
        
async function saveEdit(rowID) {
    if(!confirm("Simpan semua perubahan ini?")) return;

    // Kumpul semua data dari input
    const payload = {
        row: rowID,
        tarikh: document.getElementById(`ed_date_${rowID}`).value,
        pegawai: document.getElementById(`ed_name_${rowID}`).value,
        negeri: document.getElementById(`ed_state_${rowID}`).value,
        daerah: document.getElementById(`ed_dist_${rowID}`).value,
        lokasi: document.getElementById(`ed_loc_${rowID}`).value,
        coord: document.getElementById(`ed_coord_${rowID}`).value,
        tanaman: document.getElementById(`ed_crop_${rowID}`).value,
        varieti: document.getElementById(`ed_var_${rowID}`).value,
        luasT: document.getElementById(`ed_lt_${rowID}`).value,
        luasS: document.getElementById(`ed_ls_${rowID}`).value,
        syor: document.getElementById(`ed_syor_${rowID}`).value
    };

    const btn = event.target.closest('button'); // Updated to support inner icons if any
    const oriText = btn ? btn.innerHTML : "Simpan Perubahan"; // Safe default

    if (btn) {
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Simpan...';
      btn.disabled = true;
    }

    const r = await postData('updateEntry', payload);

    if(r.success) {
        alert("✅ Data berjaya dikemaskini!");
        location.reload();
    } else {
        alert("❌ " + r.message);
        if (btn) {
          btn.innerHTML = oriText;
          btn.disabled = false;
        }
    }
}
        function movePg(v) { pg = Math.max(1, pg+v); renTab(); }

        /* --- LOGIC CARD VIEW UPDATE (FIX NAMA COLUMN IMAGE) --- */
        async function loadPend() {
            const container = document.getElementById('verifyContainer');
            container.innerHTML = '<div class="col-12 text-center p-5"><div class="spinner-border text-primary"></div></div>';
            
            try {
                const d = await postData('getPending', {state: uProf.state});
                currentPendingRows = d.rows || [];

                if(!d.rows || !d.rows.length) {
                    container.innerHTML = '<div class="col-12 text-center p-5 text-muted bg-white rounded border border-dashed"><i class="bi bi-check-circle fs-3 text-success d-block mb-2"></i>Tiada data baru untuk disahkan.</div>';
                    return;
                }

                container.innerHTML = "";

                // Helper: Bersihkan Link Gambar
                const cleanImageLink = (raw) => { 
                    if (!raw) return []; 
                    let str = String(raw).trim(); 
                    if(str.length < 5) return []; 
                    // Buang aksara JSON/kurungan
                    str = str.replace(/[\[\]"'\\]/g, ''); 
                    // Pecahkan ikut koma
                    return str.split(',').map(l => l.trim()).filter(l => l.toLowerCase().startsWith('http')); 
                }

                d.rows.forEach((r) => {
                    const getVal = (key) => { const i = d.headers.findIndex(h => h.toLowerCase().includes(key.toLowerCase())); return i > -1 ? r.data[i] : ""; }
                    
                    // Mapping Data
                    const tarikh = getVal('Tarikh') || getVal('Date');
                    const nama = getVal('Nama') || getVal('Pegawai');
                    const email = getVal('Email') || "-";
                    const negeri = getVal('Negeri') || "-";
                    const daerah = getVal('Daerah') || "-";
                    const lokasi = getVal('Lokasi') || getVal('Kebun') || "-";
                    const koordinat = getVal('Koordinat') || "-";
                    const tanaman = getVal('Nama Tanaman') || getVal('Tanaman') || "-";
                    const varieti = getVal('Varieti') || "-";
                    const luasTanam = getVal('Luas Bertanam') || getVal('Luas') || "-";
                    const syor = getVal('Syor') || "-";
                    const timestamp = getVal('Timestamp') || tarikh;

                    // 1. Table Serangan
                    let pestRows = "";
                    try {
                        const lsObj = JSON.parse(getVal('Luas Serangan') || "{}");
                        const pctObj = JSON.parse(getVal('Peratus') || "{}");
                        const kObj = JSON.parse(getVal('Keterukan') || "{}");
                        
                        if(Object.keys(lsObj).length > 0) {
                            Object.keys(lsObj).forEach(k => {
                                let level = kObj[k] || 0;
                                let badgeColor = level < 3 ? 'success' : (level < 4 ? 'warning' : 'danger');
                                pestRows += `
                                <tr>
                                    <td style="font-size:0.85rem">${k}</td>
                                    <td class="text-center fw-bold">${lsObj[k]}</td>
                                    <td class="text-center small">${pctObj[k]||0}%</td>
                                    <td class="text-center"><span class="badge bg-${badgeColor}">T${level}</span></td>
                                </tr>`;
                            });
                        } else {
                            pestRows = `<tr><td colspan="4" class="text-center text-muted small">Tiada Serangan</td></tr>`;
                        }
                    } catch(e) { pestRows = `<tr><td colspan="4" class="text-center text-muted small">Ralat Data</td></tr>`; }

                    // 2. Logic Gambar (UPDATED COLUMN NAME)
                    // KITA CARI NAMA SPESIFIK DULU
                    const rawImg = getVal('IMAGE LINKS (COMMA SEPARATED)') || getVal('Gambar') || getVal('Image') || getVal('Foto');
                    const imgLinks = cleanImageLink(rawImg);
                    
                    let imgHTML = "";
                    if (imgLinks.length > 0) {
                        // Ada gambar
                        imgHTML = `<div class="mt-3 pt-2 border-top">
                            <h6 class="fw-bold text-secondary small mb-2 text-uppercase"><i class="bi bi-paperclip me-1"></i> LAMPIRAN GAMBAR (${imgLinks.length})</h6>
                            <div class="d-flex flex-wrap gap-2">`;
                        imgLinks.forEach((lnk, i) => {
                            imgHTML += `<a href="${lnk}" target="_blank" class="btn btn-sm btn-outline-primary bg-white shadow-sm text-truncate text-uppercase fw-bold" style="max-width: 140px;">
                                <i class="bi bi-image me-1"></i> Gambar ${i+1}
                            </a>`;
                        });
                        imgHTML += `</div></div>`;
                    } else {
                        // Tiada gambar
                        imgHTML = `<div class="mt-3 pt-2 border-top"><small class="text-muted fst-italic text-uppercase"><i class="bi bi-slash-circle me-1"></i> TIADA GAMBAR DILAMPIRKAN</small></div>`;
                    }

                    const cardHTML = `
                    <div class="col-md-6 col-xl-4">
                        <div class="verify-card bg-white rounded-3 shadow-sm border mb-3 h-100">
                            <div class="p-3 border-bottom bg-light d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="small text-muted mb-1"><i class="bi bi-calendar3 me-1"></i> ${timestamp}</div>
                                    <div class="fw-bold text-uppercase text-dark">${nama}</div>
                                    <div class="small text-muted fst-italic">${email}</div>
                                </div>
                                <span class="badge bg-warning text-dark shadow-sm">BARU</span>
                            </div>

                            <div class="p-3 pb-0">
                                <h6 class="fw-bold text-success mb-3 small border-bottom pb-2 text-uppercase"><i class="bi bi-info-circle-fill me-1"></i> LOKASI & TANAMAN</h6>
                                
                                <div class="row g-2 mb-1" style="font-size:0.9rem">
                                    <div class="col-4 fw-bold text-secondary text-uppercase">NEGERI:</div>
                                    <div class="col-8 text-uppercase fw-bold text-dark">${negeri}</div>
                                </div>
                                <div class="row g-2 mb-1" style="font-size:0.9rem">
                                    <div class="col-4 fw-bold text-secondary text-uppercase">DAERAH:</div>
                                    <div class="col-8 text-uppercase fw-bold text-dark">${daerah}</div>
                                </div>
                                <div class="row g-2 mb-1" style="font-size:0.9rem">
                                    <div class="col-4 fw-bold text-secondary text-uppercase">LOKASI:</div>
                                    <div class="col-8 fw-bold text-dark text-uppercase">${lokasi}</div>
                                </div>
                                <div class="row g-2 mb-1" style="font-size:0.9rem">
                                    <div class="col-4 fw-bold text-secondary text-uppercase">KOORDINAT:</div>
                                    <div class="col-8 font-monospace text-muted small">${koordinat}</div>
                                </div>
                                <hr class="my-2 text-muted opacity-25">
                                <div class="row g-2 mb-1" style="font-size:0.9rem">
                                    <div class="col-4 fw-bold text-secondary text-uppercase">TANAMAN:</div>
                                    <div class="col-8 fw-bold text-success text-uppercase">${tanaman}</div>
                                </div>
                                <div class="row g-2 mb-1" style="font-size:0.9rem">
                                    <div class="col-4 fw-bold text-secondary text-uppercase">VARIETI:</div>
                                    <div class="col-8 text-uppercase">${varieti}</div>
                                </div>
                                <div class="row g-2 mb-3" style="font-size:0.9rem">
                                    <div class="col-4 fw-bold text-secondary text-uppercase">LUAS TANAM:</div>
                                    <div class="col-8 text-dark text-uppercase">${luasTanam} HA</div>
                                </div>
                            </div>

                            <div class="px-3">
                                <h6 class="fw-bold text-success mb-2 small text-uppercase"><i class="bi bi-bug-fill me-1"></i> DATA SERANGAN</h6>
                                <div class="table-responsive border rounded">
                                    <table class="table table-sm table-striped mb-0" style="font-size:0.8rem">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="text-uppercase">PEROSAK</th>
                                                <th class="text-center text-uppercase">LUAS SERANGAN (HA)</th>
                                                <th class="text-center">PERATUS SERANGAN</th>
                                                <th class="text-center text-uppercase">KETERUKAN SERANGAN</th>
                                            </tr>
                                        </thead>
                                        <tbody>${pestRows}</tbody>
                                    </table>
                                </div>
                                ${imgHTML}
                            </div>

                            <div class="p-3 mt-auto">
                                <div class="alert alert-warning border-warning mb-3 py-2 px-3 small">
                                    <i class="bi bi-lightbulb-fill text-warning me-1"></i> <strong class="text-uppercase">SYOR KAWALAN:</strong> ${syor}
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-danger flex-grow-1 fw-bold text-uppercase" onclick="subVer(${r.row},'REJECT')">TOLAK</button>
                                    <button class="btn btn-success flex-grow-1 fw-bold shadow-sm text-uppercase" onclick="subVer(${r.row},'APPROVE')">SAHKAN</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    container.innerHTML += cardHTML;
                });
            } catch(e) { console.error(e); container.innerHTML='<div class="col-12 text-center p-5 text-danger">Ralat memuatkan data.</div>'; }
        }

        async function subVer(row, act) { let re = ""; if(act==='REJECT'){ re=prompt("Sebab:"); if(!re) return; } else if(!confirm("Sahkan data ini?")) return; const r = await postData('submitVerify', {row:row, act:act, reason:re, name:uProf.name}); alert(r.message); if(r.success) { loadPend(); checkPendingCount(); initDash(); } }

        async function approveAll() {
            if(!currentPendingRows || currentPendingRows.length === 0) { alert("Tiada data untuk disahkan."); return; }
            if(!confirm(`⚠️ AMARAN: Sahkan SEMUA ${currentPendingRows.length} rekod ini sekaligus?`)) return;

            const prog = document.getElementById('bulkProgress');
            const bar = document.getElementById('progBar');
            const txt = document.getElementById('progText');
            prog.style.display = 'block';

            let count = 0;
            for (const r of currentPendingRows) {
                await postData('submitVerify', {row: r.row, act: 'APPROVE', reason: 'Bulk Approval', name: uProf.name});
                count++;
                let pct = Math.round((count / currentPendingRows.length) * 100);
                bar.style.width = pct + "%";
                txt.innerText = `${count} / ${currentPendingRows.length}`;
            }
            alert("✅ Selesai! Semua data telah disahkan.");
            prog.style.display = 'none';
            loadPend(); initDash(); checkPendingCount();
        }

        async function downloadDualExcel() { if (!fData.length) { alert("Tiada data!"); return; } const workbook = new ExcelJS.Workbook(); const worksheet = workbook.addWorksheet('Laporan Penuh'); worksheet.columns = [{ header: 'ID', key: 'id', width: 6 }, { header: 'Tarikh', key: 't', width: 12 }, { header: 'Negeri', key: 'n', width: 15 }, { header: 'Daerah', key: 'd', width: 15 }, { header: 'Lokasi', key: 'l', width: 22 }, { header: 'Koordinat', key: 'c', width: 22 }, { header: 'Kategori', key: 'kt', width: 18 }, { header: 'Tanaman', key: 'tn', width: 18 }, { header: 'Luas Bancian (Ha)', key: 'lt', width: 18 }, { header: 'Syor Kawalan', key: 's', width: 25 }, { header: 'Pegawai', key: 'pg', width: 20 }, { header: 'Perosak', key: 'p', width: 20 }, { header: 'Keterukan', key: 'k', width: 18 }, { header: 'Luas Serangan (Ha)', key: 'ls', width: 18 }, { header: '% Serangan', key: 'pct', width: 15 }]; worksheet.getRow(1).font = { bold: true }; worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' }; let rowIndex = 2; fData.forEach(d => { let pestEntries = (d.p && Object.keys(d.p).length > 0) ? Object.entries(d.p) : [["TIADA", 0]]; let startRow = rowIndex; let luasTanam = parseFloat(d.lt) || 0; pestEntries.forEach(([pName, pArea]) => { let luasSerang = parseFloat(pArea) || 0; let pctVal = (luasTanam > 0) ? ((luasSerang / luasTanam) * 100).toFixed(2) + '%' : "0%"; const row = worksheet.getRow(rowIndex); row.values = { id: d.id, t: d.t, n: d.n, d: d.d, l: d.l, c: d.c || "-", kt: d.kt || "-", tn: d.tn, lt: luasTanam, s: d.s, pg: d.pg || "-", p: pName, k: d.k, ls: luasSerang, pct: pctVal }; row.eachCell({ includeEmpty: true }, (cell) => { cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} }; }); rowIndex++; }); if (pestEntries.length > 1) { for (let c = 1; c <= 11; c++) { worksheet.mergeCells(startRow, c, rowIndex - 1, c); } } for (let r = startRow; r < rowIndex; r++) { for (let c = 1; c <= 11; c++) { worksheet.getCell(r, c).alignment = { vertical: 'middle', horizontal: 'center', wrapText: true }; } } }); const buffer = await workbook.xlsx.writeBuffer(); const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }); const url = window.URL.createObjectURL(blob); const anchor = document.createElement('a'); anchor.href = url; anchor.download = 'PNR_Laporan_Lengkap.xlsx'; anchor.click(); window.URL.revokeObjectURL(url); }
        async function dlPDF() { const btn = document.querySelector('button[onclick="dlPDF()"]'); btn.innerHTML = "Jana..."; btn.disabled = true; let dateLabel = "Terkini"; if (fData.length > 0) { const sortedDates = fData.map(d => d.t).sort(); const fmt = (d) => d.split('-').reverse().join('/'); dateLabel = fmt(sortedDates[0]) === fmt(sortedDates[sortedDates.length-1]) ? fmt(sortedDates[0]) : `${fmt(sortedDates[0])} - ${fmt(sortedDates[sortedDates.length-1])}`; } try { const m = { user: uProf.name, negeri: document.getElementById('selNegeri').value || "Semua", dates: dateLabel }; const r = await postData('genPDF', {data: fData, meta: m}); if(r.success) { const a = document.createElement('a'); a.href = "data:application/pdf;base64," + r.base64; a.download = r.filename; a.click(); } } catch(e) { console.error(e); } btn.innerHTML = '<i class="bi bi-file-earmark-pdf"></i> PDF'; btn.disabled = false; }
    </script>
</body>
</html>
