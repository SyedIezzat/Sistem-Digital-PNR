<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard PNR</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#f8f9fa}
#loginOverlay{position:fixed;inset:0;background:#212529;display:flex;align-items:center;justify-content:center}
.login-box{background:#fff;padding:30px;border-radius:12px;width:100%;max-width:400px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <div class="login-box text-center shadow">
    <h4 class="mb-3">ðŸ”’ Akses Dashboard</h4>
    <input id="usernameInput" class="form-control mb-2" placeholder="Username">
    <input id="passwordInput" type="password" class="form-control mb-3" placeholder="Password">
    <button onclick="attemptLogin()" class="btn btn-success w-100">Log Masuk</button>
    <div id="loginError" class="text-danger small mt-2"></div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardWrapper" style="display:none">

<nav class="navbar navbar-dark bg-success px-3">
  <span class="navbar-brand">ðŸŒ± Dashboard PNR</span>
  <span id="welcomeUser" class="text-white small"></span>
</nav>

<div class="container mt-4">

<!-- KPI -->
<div class="row g-3 mb-4" id="kpiSection">
  <div class="col-md-4">
    <div class="card border-start border-5 border-success shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Jumlah Rekod</div>
        <h3 id="kpiJumlahRekod">0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-start border-5 border-danger shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Jumlah Luas Serangan (ha)</div>
        <h3 id="kpiLuasSerangan">0</h3>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-start border-5 border-warning shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Indeks Serangan (%)</div>
        <h3 id="kpiIndeks">0%</h3>
      </div>
    </div>
  </div>
</div>

<!-- CHART -->
<div class="card shadow-sm">
  <div class="card-body">
    <h6 class="mb-3">ðŸ“Š Luas Serangan Mengikut Negeri</h6>
    <canvas id="chartNegeri" height="120"></canvas>
  </div>
</div>

</div>
</div>

<script>
/* =============================
   KONFIGURASI
============================= */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxm90FJG-b5kkafVVU0urpCg_m7XAXrRsZW8LJlyM8l3VhPj5wJoqM2sckJmfb4BkbTsQ/exec";

/* =============================
   GLOBAL
============================= */
let loggedInUser = null;
let dashboardData = [];
let chartNegeriObj = null;

/* =============================
   LOGIN
============================= */
function attemptLogin() {
  const u = usernameInput.value.trim();
  const p = passwordInput.value.trim();
  if (!u || !p) {
    loginError.innerText = "Sila isi login";
    return;
  }

  fetch(`${WEBAPP_URL}?action=verifyUserLogin&username=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}`)
    .then(r => r.json())
    .then(res => {
      if (res.error) {
        loginError.innerText = res.message;
        return;
      }

      loggedInUser = res;
      loginOverlay.style.display = "none";
      dashboardWrapper.style.display = "block";
      welcomeUser.innerText = `Selamat datang, ${res.name} (${res.role.toUpperCase()})`;

      loadAnalisisData();
    })
    .catch(() => alert("Ralat sambungan"));
}

/* =============================
   LOAD DATA
============================= */
function loadAnalisisData() {
  fetch(`${WEBAPP_URL}?action=getAllDashboardData&state=${loggedInUser.state}`)
    .then(r => r.json())
    .then(data => {

      // Backend return JSON STRING
      if (typeof data === "string") {
        data = JSON.parse(data);
      }

      console.log("DATA DITERIMA:", data);

      if (!Array.isArray(data) || data.length === 0) {
        alert("Tiada data DISAHKAN");
        return;
      }

      dashboardData = data;
      kiraKPI(data);
      binaCarta(data);
    })
    .catch(err => {
      console.error(err);
      alert("Ralat API");
    });
}

/* =============================
   KPI
============================= */
function kiraKPI(data) {
  let jumlahRekod = data.length;
  let jumlahSerangan = 0;

  data.forEach(d => {
    jumlahSerangan += Number(d.luasSerangan || 0);
  });

  let indeks = jumlahRekod > 0
    ? (jumlahSerangan / jumlahRekod).toFixed(2)
    : 0;

  kpiJumlahRekod.innerText = jumlahRekod;
  kpiLuasSerangan.innerText = jumlahSerangan.toFixed(2);
  kpiIndeks.innerText = indeks + "%";
}

/* =============================
   CHART
============================= */
function binaCarta(data) {
  const map = {};

  data.forEach(d => {
    const negeri = d.negeri || "Tidak Diketahui";
    const luas = Number(d.luasSerangan || 0);
    map[negeri] = (map[negeri] || 0) + luas;
  });

  const labels = Object.keys(map);
  const values = Object.values(map);

  if (chartNegeriObj) chartNegeriObj.destroy();

  chartNegeriObj = new Chart(
    document.getElementById("chartNegeri"),
    {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "Luas Serangan (ha)",
          data: values
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        }
      }
    }
  );
}
</script>

</body>
</html>
