<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PNR Pro Dashboard</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --primary: #064e3b; --accent: #10b981; --bg: #f8fafc; }
    body { background: var(--bg); font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; overflow-x: hidden; }
    
    /* LOGIN */
    #loginOverlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    
    /* LAYOUT */
    .sidebar { width: 250px; position: fixed; top: 0; bottom: 0; background: white; border-right: 1px solid #e2e8f0; z-index: 100; padding: 20px; overflow-y: auto; transition:0.3s; }
    .main-content { margin-left: 250px; padding: 25px; transition:0.3s; }
    
    /* CARDS & CHARTS */
    .stat-card { background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid var(--accent); }
    .chart-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
    #map { height: 350px; border-radius: 10px; width: 100%; z-index: 1; }
    
    /* NAV */
    .nav-link { cursor: pointer; padding: 10px; border-radius: 8px; color: #64748b; margin-bottom: 5px; font-weight: 500; }
    .nav-link.active, .nav-link:hover { background: #f1f5f9; color: var(--primary); }
    
    /* MOBILE RESPONSIVE */
    @media(max-width:768px){ .sidebar{transform:translateX(-100%)} .main-content{margin-left:0} .sidebar.active{transform:translateX(0)} }
  </style>
</head>
<body>

  <script>
    // ⚠️ PENTING: Gantikan URL di bawah dengan URL Web App anda sendiri!
    const API_URL = "https://script.google.com/macros/s/AKfycbwdxk4dyXCznUkETS8abnR6MuRvDEAIGSxNF0tLJmDCKLvI5DB_axm2FWQY2PF3sF4F/exec"; 
  </script>
<script>
    // --- GLOBAL VARIABLES ---
    let mData=[], fData=[], uProf=null, charts={}, map=null, layer=null, pg=1, pSize=10;

    // --- CORE: POST DATA FUNCTION (ENJIN UTAMA) ---
    async function postData(action, payload) {
      // Kita hantar action dalam Query String & Body untuk backup
      const url = `${API_URL}?action=${action}`;
      
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" }, 
        body: JSON.stringify({...payload, action: action})
      });
      
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        console.error("Non-JSON Response:", text);
        throw new Error("Ralat Server. Sila semak deployment 'Anyone'.");
      }
    }

    // 1. LOGIN
    async function doLogin(){
      const u=document.getElementById('uid').value, p=document.getElementById('pwd').value, b=document.getElementById('btnLogin');
      const msg=document.getElementById('loginMsg');
      
      if(!u || !p) { msg.innerText="Sila isi ID dan Kata Laluan."; return; }
      
      b.disabled=true; b.innerText="Memproses..."; msg.innerText="";
      
      try {
        const r = await postData('login', {u, p});
        
        if(r.success){ 
          uProf=r; 
          document.getElementById('uDisp').innerText=r.name; 
          document.getElementById('loginOverlay').style.display='none'; 
          initDash(); 
        } else { 
          msg.innerText=r.message || "Login Gagal."; 
          b.disabled=false; b.innerText="LOG MASUK"; 
        }
      } catch(e) { 
        msg.innerText=e.message; b.disabled=false; b.innerText="LOG MASUK"; 
      }
    }

    // 2. DASHBOARD INIT (FIXED: Guna postData)
    async function initDash(){
      try {
        // SEBELUM INI ERROR DI SINI SEBAB GUNA getData
        // SEKARANG KITA GUNA postData
        const d = await postData('getAnalytics', { state: uProf.state });
        
        if(d.error) { alert("Ralat Data: " + d.error); return; }
        
        mData=d.records;
        fillSel('selNegeri',d.filters.negeri); 
        fillSel('selTanaman',d.filters.tanaman); 
        fillSel('selKategori',d.filters.kategori);
        
        if(uProf.state!=="ALL"){ 
          const el = document.getElementById('selNegeri');
          el.value=uProf.state; el.disabled=true; 
        }
        
        if(!map){ 
          map=L.map('map').setView([4.2105,101.9758],6); 
          L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map); 
        }
        
        runFilter();
      } catch(e) { console.error("Dash Init Error:", e); }
    }

    // 3. FILTER LOGIC
    function runFilter(){
      const n=document.getElementById('selNegeri').value, t=document.getElementById('selTanaman').value, k=document.getElementById('selKategori').value;
      const s=document.getElementById('dS').value, e=document.getElementById('dE').value;
      
      fData = mData.filter(d => {
        let ok = (n===""||d.n===n) && (t===""||d.tn===t) && (k===""||d.kt===k);
        if(s && d.t<s) ok=false; 
        if(e && d.t>e) ok=false;
        return ok;
      });
      
      pg=1; calcUI();
    }

    // 4. CALCULATE UI
    function calcUI(){
      let tt=0, ts=0, pm={}, km={1:0,2:0,3:0,4:0,5:0}, pts=[];
      
      fData.forEach(d=>{
        tt+=d.lt; ts+=d.ls;
        if(d.p) Object.keys(d.p).forEach(x=>pm[x]=(pm[x]||0)+(parseFloat(d.p[x])||0));
        if(d.k>0) km[d.k]++;
        if(d.c && d.c.includes(',') && d.ls>0) pts.push(d.c.split(',').map(Number));
      });
      
      document.getElementById('k1').innerText=tt.toFixed(2); 
      document.getElementById('k2').innerText=ts.toFixed(2);
      document.getElementById('k3').innerText=tt>0?((ts/tt)*100).toFixed(2)+"%":"0%"; 
      document.getElementById('k4').innerText=fData.length;
      
      upChart(pm,km);
      if(layer) map.removeLayer(layer);
      if(pts.length) layer=L.layerGroup(pts.map(p=>L.circleMarker(p,{radius:4,color:'red',fillOpacity:0.8,stroke:false}))).addTo(map);
      
      renTab();
    }

    // 5. PAGINATION
    function renTab(){
      const st=(pg-1)*pSize, dt=fData.slice(st,st+pSize);
      document.getElementById('tBody').innerHTML = dt.map(d=>`
        <tr>
          <td>${d.t}</td><td>${d.n}</td><td>${d.l}</td><td>${d.tn}</td>
          <td>${d.lt.toFixed(2)}</td><td class="text-danger fw-bold">${d.ls.toFixed(2)}</td>
        </tr>`).join('');
      document.getElementById('pgInfo').innerText=`Pg ${pg}/${Math.ceil(fData.length/pSize)}`;
    }
    function movePg(d){ pg=Math.max(1,Math.min(Math.ceil(fData.length/pSize),pg+d)); renTab(); }

    // 6. PDF DOWNLOAD
    async function dlPDF(){
      if(!fData.length){alert("Tiada data!");return;}
      
      const btn=document.querySelector('button[onclick="dlPDF()"]'), txt=btn.innerHTML;
      btn.innerHTML='<span class="spinner-border spinner-border-sm"></span> Jana...'; btn.disabled=true;
      
      const ds=document.getElementById('dS').value||"Awal", de=document.getElementById('dE').value||"Kini";
      const meta={
        user:uProf.name, 
        negeri:document.getElementById('selNegeri').value||"Semua Negeri", 
        dates:`${ds} hingga ${de}`
      };
      
      try {
        const r = await postData('genPDF', {data: fData, meta: meta});
        btn.innerHTML=txt; btn.disabled=false;
        if(r.success){ 
          const a=document.createElement('a'); 
          a.href="data:application/pdf;base64,"+r.base64; 
          a.download=r.filename; 
          document.body.appendChild(a); a.click(); document.body.removeChild(a); 
        } else { alert("Ralat PDF: "+r.message); }
      } catch(e) { alert("Server Error"); btn.disabled=false; }
    }

    // 7. VERIFICATION MODULE (FIXED: Guna postData)
    async function loadPend(){
      const tb=document.getElementById('vBody'); 
      tb.innerHTML='<tr><td colspan="100%" class="text-center p-3"><div class="spinner-border text-primary"></div></td></tr>';
      
      try {
        // ERROR SEBELUM INI JUGA DI SINI (getData is not defined)
        // SEKARANG KITA GUNA postData
        const d = await postData('getPending', { state: uProf.state });
        const r=d.rows, h=d.headers;
        
        document.getElementById('badgePending').innerText=r.length; 
        document.getElementById('badgePending').style.display=r.length?'inline':'none';
        
        if(!r.length){ 
          tb.innerHTML='<tr><td colspan="100%" class="text-center p-3 text-muted">Tiada Data Baru</td></tr>'; 
          document.getElementById('vHead').innerHTML='';
          return; 
        }
        
        let hh=`<th>#</th>`; h.forEach(x=>hh+=`<th>${x}</th>`); 
        hh+=`<th class="bg-warning text-dark sticky-end" style="right:0">AKSI</th>`; 
        document.getElementById('vHead').innerHTML=hh;
        
        let bb=``; 
        r.forEach((x,i)=>{
          bb+=`<tr id="r-${x.row}"><td class="text-center text-muted">${i+1}</td>`;
          x.data.forEach(c=>{ 
            let s=String(c); 
            bb+=`<td>${s.length>40?`<span title="${s}">${s.substr(0,40)}..</span>`:s}</td>` 
          });
          bb+=`<td class="bg-light sticky-end" style="right:0">
                 <div class="btn-group btn-group-sm">
                   <button onclick="subVer(${x.row},'APPROVE')" class="btn btn-success" title="Sahkan"><i class="bi bi-check-lg"></i></button> 
                   <button onclick="subVer(${x.row},'REJECT')" class="btn btn-danger" title="Tolak"><i class="bi bi-x-lg"></i></button>
                 </div>
               </td></tr>`;
        });
        tb.innerHTML=bb;
      } catch(e) { 
        console.error(e); 
        tb.innerHTML='<tr><td colspan="100%" class="text-center text-danger">Gagal memuatkan data.</td></tr>'; 
      }
    }

    async function subVer(r,act){
      let re=""; 
      if(act==='REJECT'){ 
        re=prompt("Sila nyatakan sebab penolakan (WAJIB):"); 
        if(re===null)return; 
        if(!re.trim()){alert("Wajib isi sebab!");return;}
      } else {
        if(!confirm("Sahkan data ini?")) return;
      }
      
      document.getElementById('r-'+r).style.opacity='0.4';
      
      try {
        const res = await postData('submitVerify', {row: r, act: act, reason: re, name: uProf.name});
        
        if(res.success){ 
          document.getElementById('r-'+r).remove(); 
          const b=document.getElementById('badgePending'); 
          b.innerText=Math.max(0, parseInt(b.innerText)-1); 
          initDash(); // Refresh background data
        } else { 
          alert("Gagal: "+res.message); 
          document.getElementById('r-'+r).style.opacity='1'; 
        }
      } catch(e) { alert("Server Error"); document.getElementById('r-'+r).style.opacity='1'; }
    }

    // 8. HELPERS
    function switchTab(v,e){
      document.getElementById('view-main').style.display = v==='main'?'block':'none';
      document.getElementById('view-verify').style.display = v==='verify'?'block':'none';
      document.getElementById('filterSec').style.display = v==='main'?'block':'none';
      
      document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active')); 
      e.classList.add('active');
      
      if(v==='verify') loadPend();
    }
    
    function fillSel(i,a){ 
      const e=document.getElementById(i); 
      e.innerHTML='<option value="">Semua</option>'; 
      a.forEach(x=>{if(x)e.innerHTML+=`<option value="${x}">${x}</option>`});
    }
    
    function upChart(p,k){
      const tp=Object.entries(p).sort((a,b)=>b[1]-a[1]).slice(0,10);
      
      if(charts.b)charts.b.destroy(); 
      charts.b=new Chart(document.getElementById('cBar'),{
        type:'bar',
        data:{
          labels:tp.map(x=>x[0]),
          datasets:[{label:'Ha',data:tp.map(x=>x[1]),backgroundColor:'#10b981',borderRadius:4}]
        },
        options:{indexAxis:'y',maintainAspectRatio:false,responsive:true}
      });
      
      if(charts.p)charts.p.destroy(); 
      charts.p=new Chart(document.getElementById('cPie'),{
        type:'doughnut',
        data:{
          labels:['1','2','3','4','5'],
          datasets:[{data:Object.values(k),backgroundColor:['#22c55e','#84cc16','#eab308','#f97316','#ef4444']}]
        },
        options:{maintainAspectRatio:false,responsive:true,plugins:{legend:{position:'right'}}}
      });
    }
  </script>
</body>
</html>
