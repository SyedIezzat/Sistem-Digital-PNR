<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem PNR Digital</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <style>
        :root { --primary: #064e3b; --accent: #10b981; --bg: #f3f4f6; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; }
        
        /* LOGIN OVERLAY */
        #loginOverlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 2rem; border-radius: 10px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }

        /* SIDEBAR */
        .sidebar { width: 260px; height: 100vh; position: fixed; top: 0; left: 0; background: white; border-right: 1px solid #e5e7eb; padding: 20px; z-index: 100; transition: transform 0.3s; }
        .brand { font-size: 1.2rem; font-weight: 800; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: #4b5563; font-weight: 500; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .nav-item:hover { background: #f9fafb; color: var(--primary); }
        .nav-item.active { background: #ecfdf5; color: var(--primary); font-weight: 700; }
        
        /* MAIN CONTENT */
        .main-content { margin-left: 260px; padding: 25px; }
        
        /* CARDS */
        .kpi-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); border: 1px solid #e5e7eb; height: 100%; }
        .kpi-title { font-size: 0.8rem; text-transform: uppercase; color: #6b7280; font-weight: 600; letter-spacing: 0.5px; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: #111827; margin-top: 5px; }
        .kpi-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }

        /* CHARTS & TABLE */
        .chart-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; margin-bottom: 20px; height: 350px; position: relative; }
        .map-box { height: 400px; border-radius: 12px; overflow: hidden; border: 1px solid #e5e7eb; position: relative; z-index: 1; }
        .table-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; overflow: hidden; }
        
        /* HELPERS */
        .text-danger { color: #dc2626 !important; }
        .badge-pending { background: #dc2626; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; display: none; }
        
        /* MOBILE */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <div class="brand justify-content-center mb-4"><i class="bi bi-flower1"></i> PNR DIGITAL</div>
            <h6 class="text-muted mb-4">Log Masuk Sistem</h6>
            <input type="text" id="uid" class="form-control mb-3" placeholder="ID Pengguna">
            <input type="password" id="pwd" class="form-control mb-4" placeholder="Kata Laluan">
            <button type="button" onclick="doLogin()" class="btn btn-success w-100 fw-bold" id="btnLogin">MASUK</button>
            <small id="loginMsg" class="text-danger d-block mt-3"></small>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="brand"><i class="bi bi-flower1"></i> PNR DIGITAL</div>
        
        <div class="nav-item active" onclick="switchTab('main', this)">
            <span><i class="bi bi-grid-1x2-fill me-2"></i> Dashboard</span>
        </div>
        
        <div class="nav-item" id="navVerify" style="display:none" onclick="switchTab('verify', this)">
            <span><i class="bi bi-check-circle-fill me-2"></i> Pengesahan</span>
            <span class="badge-pending" id="badgePending">0</span>
        </div>

        <hr class="my-4">
        
        <div class="mb-3 px-2">
            <small class="text-muted fw-bold" style="font-size:0.7rem">TAPISAN DATA</small>
            <select id="selNegeri" class="form-select form-select-sm mt-2" onchange="runFilter()"></select>
            <select id="selTanaman" class="form-select form-select-sm mt-2" onchange="runFilter()"></select>
            <select id="selKategori" class="form-select form-select-sm mt-2" onchange="runFilter()"></select>
            <div class="row g-1 mt-1">
                <div class="col-6"><input type="date" id="dS" class="form-control form-control-sm" onchange="runFilter()"></div>
                <div class="col-6"><input type="date" id="dE" class="form-control form-control-sm" onchange="runFilter()"></div>
            </div>
        </div>

        <button onclick="window.open(BANCIAN_URL, '_blank')" class="btn btn-success w-100 btn-sm fw-bold mb-2">
            <i class="bi bi-plus-lg"></i> Tambah Data
        </button>
        
        <div class="mt-auto pt-3 border-top">
            <div class="d-flex align-items-center justify-content-between px-2">
                <div><small class="text-muted d-block">Pengguna</small><strong id="uDisp" style="font-size:0.85rem">-</strong></div>
                <button class="btn btn-link text-danger btn-sm" onclick="location.reload()"><i class="bi bi-box-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="d-md-none mb-3 d-flex justify-content-between">
            <span class="fw-bold text-success"><i class="bi bi-flower1"></i> PNR</span>
            <button class="btn btn-light btn-sm border" onclick="document.getElementById('sidebar').classList.toggle('active')"><i class="bi bi-list"></i></button>
        </div>

        <div id="view-main">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="fw-bold m-0 text-dark">Analisis Data</h4>
                    <small class="text-muted" id="lastUpdate">Data setakat: Terkini</small>
                </div>
                <div class="btn-group">
                    <button class="btn btn-white border bg-white text-secondary btn-sm" onclick="initDash()"><i class="bi bi-arrow-clockwise"></i></button>
                    <button class="btn btn-success btn-sm" onclick="downloadDualExcel()"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                    <button class="btn btn-danger btn-sm" onclick="dlPDF()"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
                </div>
            </div>

            <div class="card mb-4 border-0 shadow-sm" style="background: #e0f2fe;">
                <div class="card-body d-flex align-items-center p-3">
                    <div class="bg-white p-2 rounded-circle text-primary me-3 shadow-sm">
                        <i class="bi bi-robot fs-4"></i>
                    </div>
                    <div>
                        <h6 class="fw-bold text-primary mb-1">Analisis Pintar</h6>
                        <div id="smartSummary" class="small text-dark">Sedang menganalisis data...</div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="d-flex justify-content-between">
                            <span class="kpi-title">Luas Bancian</span>
                            <div class="kpi-icon bg-success-subtle text-success"><i class="bi bi-rulers"></i></div>
                        </div>
                        <div class="kpi-value" id="k1">0</div>
                        <small class="text-muted">Hektar</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="d-flex justify-content-between">
                            <span class="kpi-title">Luas Serangan</span>
                            <div class="kpi-icon bg-danger-subtle text-danger"><i class="bi bi-bug-fill"></i></div>
                        </div>
                        <div class="kpi-value text-danger" id="k2">0</div>
                        <small class="text-muted">Hektar</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="d-flex justify-content-between">
                            <span class="kpi-title">Peratus Serangan</span>
                            <div class="kpi-icon bg-warning-subtle text-warning"><i class="bi bi-percent"></i></div>
                        </div>
                        <div class="kpi-value" id="k3">0%</div>
                        <small class="text-muted">%</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card">
                        <div class="d-flex justify-content-between">
                            <span class="kpi-title">Bil. Rekod</span>
                            <div class="kpi-icon bg-primary-subtle text-primary"><i class="bi bi-file-text"></i></div>
                        </div>
                        <div class="kpi-value" id="k4">0</div>
                        <small class="text-muted">Unit</small>
                    </div>
                </div>
            </div>

         <div class="row g-3 mb-4">
    
    <div class="col-md-8">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-body">
                <h6 class="fw-bold mb-3 text-secondary">Carta Serangan Perosak Tertinggi (Ha)</h6>
                <div style="height: 350px"> <canvas id="cBar"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-transparent border-0 py-3 d-flex align-items-center">
                <div class="icon-shape bg-warning text-white rounded-3 p-2 me-2 shadow-sm">
                    <i class="bi bi-pie-chart-fill"></i>
                </div>
                <h6 class="m-0 fw-bold text-secondary">Tahap Keterukan</h6>
            </div>
            
            <div class="card-body text-center position-relative">
                <div style="height: 250px;">
                    <canvas id="chartLevel"></canvas> 
                </div>

                <div class="mt-4 pt-3 border-top">
                    <p class="text-uppercase text-muted fw-bold mb-2" style="font-size: 10px; letter-spacing: 1px;">Petunjuk Tahap</p>
                    
                    <div class="d-flex flex-wrap justify-content-center gap-2" style="font-size: 11px;">
                        <span class="badge rounded-pill bg-success bg-opacity-75 text-white">T1: Sgt Rendah</span>
                        <span class="badge rounded-pill bg-info text-dark">T2: Rendah</span>
                        <span class="badge rounded-pill bg-warning text-dark">T3: Sederhana</span>
                        <span class="badge rounded-pill text-white" style="background-color: #fd7e14;">T4: Teruk</span>
                        <span class="badge rounded-pill bg-danger text-white">T5: Sgt Teruk</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
            <div class="row g-3 mb-4">
                <div class="col-md-8">
                    <div class="map-box" id="map"></div>
                </div>
                <div class="col-md-4">
                    <div class="table-box" style="height:400px; overflow-y:auto">
                        <h6 class="fw-bold mb-3 text-danger">Hotspot Daerah</h6>
                        <table class="table table-sm table-hover small">
                            <thead class="table-light"><tr><th>Daerah</th><th class="text-end">Luas (Ha)</th></tr></thead>
                            <tbody id="hotspotTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="table-box">
                <div class="d-flex justify-content-between mb-3">
                    <h6 class="fw-bold">Jadual Rekod</h6>
                    <small id="pgInfo" class="text-muted"></small>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle">
                        <thead class="table-light"><tr><th>Tarikh</th><th>Negeri</th><th>Lokasi</th><th>Tanaman</th><th>Luas Bancian</th><th>Luas Serangan</th></tr></thead>
                        <tbody id="tBody"></tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-2">
                    <button class="btn btn-sm btn-light border" onclick="movePg(-1)">Prev</button>
                    <button class="btn btn-sm btn-light border" onclick="movePg(1)">Next</button>
                </div>
            </div>
        </div>

        <div id="view-verify" style="display:none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold m-0 text-dark">Pengesahan Data</h4>
                <button class="btn btn-primary btn-sm" onclick="loadPend()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
            </div>
            <div class="table-box">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm small align-middle" style="white-space:nowrap">
                        <thead class="table-dark sticky-top" style="top:0"><tr id="vHead"></tr></thead>
                        <tbody id="vBody"><tr><td colspan="100%" class="text-center p-5 text-muted">Sila tunggu...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const API_URL = "https://script.google.com/macros/s/AKfycbybYfIRU52AkFgk2wRXguK5Ja9DAjDkbwEy-zG3B8goc1c7UvbrrDhDli4hULaTJ1s/exec";
        const BANCIAN_URL = "https://script.google.com/macros/s/AKfycbysNeegvBM-m16DFLHEM-imbcduU5LZG0G3OipMd9YNgrXWYdNCWj9Yu7NnzbvMAyErDw/exec";

        // GLOBAL VARS
        let mData=[], fData=[], uProf=null, charts={}, map=null, layer=null, pg=1, pSize=10, sessionID=null;

        // --- CORE FUNCTION ---
        async function postData(act, load) {
            try {
                const res = await fetch(`${API_URL}?action=${act}`, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({...load, action: act})
                });
                return JSON.parse(await res.text());
            } catch(e) { console.error(e); return {success:false, message:"Ralat sambungan."}; }
        }

        // --- AUTH ---
        async function doLogin() {
            const u = document.getElementById('uid').value;
            const p = document.getElementById('pwd').value;
            const btn = document.getElementById('btnLogin');
            const msg = document.getElementById('loginMsg');

            if(!u || !p) { msg.innerText = "Sila isi ID dan Kata Laluan"; return; }
            btn.disabled = true; btn.innerText = "Memproses..."; msg.innerText = "";

            const r = await postData('login', {u, p});
            if(r.success) {
                uProf = r; sessionID = r.sid;
                document.getElementById('uDisp').innerText = r.name;
                document.getElementById('loginOverlay').style.display = 'none';
                
                if(["ADMIN","PENYELIA"].includes((r.role||"").toUpperCase())) {
                    document.getElementById('navVerify').style.display = "flex";
                    checkPendingCount();
                }
                
                initDash();
                setInterval(() => { postData('heartbeat', {sid: sessionID}); }, 900000); 
            } else {
                msg.innerText = r.message; btn.disabled = false; btn.innerText = "MASUK";
            }
        }

        // --- NAV ---
        function switchTab(t, el) {
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            if(el) el.classList.add('active');
            
            document.getElementById('view-main').style.display = t==='main'?'block':'none';
            document.getElementById('view-verify').style.display = t==='verify'?'block':'none';
            
            if(t==='verify') loadPend();
            if(t==='main' && map) setTimeout(() => map.invalidateSize(), 300);
        }

        async function checkPendingCount() {
            try {
                const d = await postData('getPending', {state: uProf.state});
                const b = document.getElementById('badgePending');
                if(d.rows && d.rows.length > 0) { b.innerText = d.rows.length; b.style.display = "inline-block"; }
                else { b.style.display = "none"; }
            } catch(e){}
        }

        // --- DASHBOARD ---
        async function initDash() {
            const d = await postData('getAnalytics', {state: uProf.state});
            if(!d.records) { alert("Tiada Data"); return; }
            
            mData = d.records;
            fillSel('selNegeri', d.filters.negeri);
            fillSel('selTanaman', d.filters.tanaman);
            fillSel('selKategori', d.filters.kategori);

            if(uProf.state !== "ALL") {
                const s = document.getElementById('selNegeri');
                s.value = uProf.state; s.disabled = true;
            }

            if(!map) {
                map = L.map('map').setView([4.2105, 101.9758], 6);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            runFilter();
        }

        function runFilter() {
            const n = document.getElementById('selNegeri').value;
            const t = document.getElementById('selTanaman').value;
            const k = document.getElementById('selKategori').value;
            const s = document.getElementById('dS').value;
            const e = document.getElementById('dE').value;

            fData = mData.filter(d => {
                let ok = (n==="" || d.n===n) && (t==="" || d.tn===t) && (k==="" || d.kt===k);
                if(s && d.t < s) ok = false;
                if(e && d.t > e) ok = false;
                return ok;
            });
            pg = 1; calcUI();
        }

        function calcUI() {
            let tt=0, ts=0, pm={}, km={1:0,2:0,3:0,4:0,5:0}, pts=[], hData={};

            fData.forEach(d => {
                tt += (d.lt||0); ts += (d.ls||0);
                if(d.p && Object.keys(d.p).length > 0) Object.entries(d.p).forEach(([k,v]) => pm[k] = (pm[k]||0)+parseFloat(v));
                else if(d.ls > 0) pm["Umum"] = (pm["Umum"]||0) + d.ls;
                let l = parseInt(d.k)||0; if(l>0 && l<=5) km[l]++;
                if(d.c && d.c.includes(',')) {
                    let p = d.c.split(',').map(Number);
                    if(p.length===2 && !isNaN(p[0])) pts.push(p);
                }
                if(d.ls > 0 && d.d !== "-") hData[d.d] = (hData[d.d]||0) + d.ls;
            });

            // --- BAHAGIAN INI DIUBAH (Guna toLocaleString) ---
            
            // k1: Luas Bancian (2 titik perpuluhan + koma)
            document.getElementById('k1').innerText = tt.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // k2: Luas Serangan (2 titik perpuluhan + koma)
            document.getElementById('k2').innerText = ts.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // k3: Peratus (Kekal toFixed sebab peratus jarang ribu-ribu)
            document.getElementById('k3').innerText = tt>0 ? ((ts/tt)*100).toFixed(1)+"%" : "0%";
            
            // k4: Bilangan Rekod (Integer + koma)
            document.getElementById('k4').innerText = fData.length.toLocaleString('en-US');

            // -------------------------------------------------

            updateCharts(pm, km);
            updateMap(pts);
            updateHotspot(hData);
            genSummary(pm, tt, ts); 
            renTab();
        }

        // --- FUNGSI ANALISIS PINTAR TERPERINCI ---
        function genSummary(pm, tt, ts) {
           const el = document.getElementById('smartSummary');
           if(!el) return;

           // 1. Lokasi
           let loc = document.getElementById('selNegeri').value;
           if(loc === "") loc = "Semua Negeri";

           // 2. Tanaman Paling Terjejas
           let cropMap = {};
           fData.forEach(d => { if(d.ls > 0) cropMap[d.tn] = (cropMap[d.tn] || 0) + d.ls; });
           let topCrop = "-", topCropVal = 0;
           Object.entries(cropMap).forEach(([k,v]) => { if(v > topCropVal) { topCrop = k; topCropVal = v; } });

           // 3. Musuh Utama
           let topP="-", topV=0;
           Object.entries(pm).forEach(([k,v])=>{if(v>topV){topP=k; topV=v}});
           if(topP==="-" && ts>0) { topP="Serangan Umum"; topV=ts; }

           // 4. Purata Indeks Keterukan
           let totalScore = 0, count = 0;
           fData.forEach(d => { let level = parseInt(d.k) || 0; if(level > 0 && d.ls > 0){ totalScore += level; count++; } });
           let avgIdx = count > 0 ? (totalScore / count).toFixed(1) : "0.0";
           
           let tafsir = "Tiada", color = "text-success";
           let idxNum = parseFloat(avgIdx);
           if(idxNum > 0) {
               if(idxNum <= 1.9) { tafsir = "Sangat Ringan"; color = "text-success"; }
               else if(idxNum <= 2.9) { tafsir = "Ringan"; color = "text-success"; }
               else if(idxNum <= 3.9) { tafsir = "Sederhana"; color = "text-warning"; }
               else if(idxNum <= 4.5) { tafsir = "Teruk"; color = "text-danger"; }
               else { tafsir = "Sangat Teruk"; color = "text-danger fw-bold"; }
           }

           const pct = tt > 0 ? ((ts/tt)*100).toFixed(2) : "0.00";

           if(ts === 0) {
               el.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> Tiada rekod serangan dilaporkan.</span>`;
           } else {
               el.innerHTML = `
                <div style="line-height: 1.6;">
                    <i class="bi bi-geo-alt-fill text-danger"></i> <b>${loc}</b>: 
                    Tanaman <b class="text-primary">${topCrop}</b> paling terkesan akibat serangan <b>${topP}</b>.
                    <br>
                    <i class="bi bi-exclamation-circle-fill text-warning"></i> Luas Serangan: <b>${ts.toFixed(2)} Ha</b> (${pct}%)
                    <br>
                    <i class="bi bi-bar-chart-fill text-secondary"></i> Indeks Keterukan: <b>${avgIdx}</b> (<span class="${color}">${tafsir}</span>)
                </div>
               `;
           }
        }

        function updateCharts(pm, km) {
            const tp = Object.entries(pm).sort((a,b)=>b[1]-a[1]).slice(0,10);
            if(charts.b) charts.b.destroy();
            charts.b = new Chart(document.getElementById('cBar'), {
                type: 'bar',
                data: {
                    labels: tp.map(x=>x[0]),
                    datasets: [{ label: 'Ha', data: tp.map(x=>x[1]), backgroundColor: '#10b981', borderRadius:4 }]
                },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins:{legend:{display:false}} }
            });

            if(charts.p) charts.p.destroy();
            charts.p = new Chart(document.getElementById('cPie'), {
                type: 'doughnut',
                data: {
                    labels: ['T1','T2','T3','T4','T5'],
                    datasets: [{ data: Object.values(km), backgroundColor: ['#22c55e','#84cc16','#eab308','#f97316','#ef4444'], borderWidth:0 }]
                },
                options: { maintainAspectRatio: false, plugins:{legend:{position:'right'}} }
            });
        }

        function updateMap(pts) {
            if(layer) map.removeLayer(layer);
            if(pts.length) {
                layer = L.layerGroup(pts.map(p => L.circleMarker(p, {radius:5, color:'#dc2626', fillOpacity:0.6, stroke:false}))).addTo(map);
                map.fitBounds(L.latLngBounds(pts));
            }
        }

        function updateHotspot(hData) {
            const s = Object.entries(hData).sort((a,b)=>b[1]-a[1]).slice(0,5);
            document.getElementById('hotspotTable').innerHTML = s.length ? 
                s.map(x=>`<tr><td>${x[0]}</td><td class="text-end fw-bold text-danger">${x[1].toFixed(2)}</td></tr>`).join('') : 
                '<tr><td colspan="2" class="text-center text-muted">Tiada Data</td></tr>';
        }

        function renTab() {
            const st = (pg-1)*pSize;
            const dt = fData.slice(st, st+pSize);
            const tb = document.getElementById('tBody');
            
            if(!dt.length) { tb.innerHTML = '<tr><td colspan="6" class="text-center text-muted p-4">Tiada rekod.</td></tr>'; return; }
            
            tb.innerHTML = dt.map(d => `
                <tr>
                    <td>${d.t}</td><td>${d.n}</td><td>${d.l}</td>
                    <td><span class="badge bg-light text-dark border">${d.tn}</span></td>
                    <td>${d.lt.toFixed(2)}</td><td class="text-danger fw-bold">${d.ls.toFixed(2)}</td>
                </tr>
            `).join('');
            document.getElementById('pgInfo').innerText = `Page ${pg}`;
        }

        function movePg(v) { pg = Math.max(1, pg+v); renTab(); }
        function fillSel(id, arr) { 
            const el = document.getElementById(id); 
            el.innerHTML='<option value="">Semua</option>'; 
            arr.forEach(x => {if(x) el.innerHTML+=`<option value="${x}">${x}</option>`}); 
        }

        // --- EXPORT & VERIFY ---
   async function downloadDualExcel() {
            if (!fData.length) { alert("Tiada data!"); return; }

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Laporan Penuh');

            // 1. SETUP KOLUM (15 Kolum Semuanya)
            worksheet.columns = [
                { header: 'ID', key: 'id', width: 6 },
                { header: 'Tarikh', key: 't', width: 12 },
                { header: 'Negeri', key: 'n', width: 15 },
                { header: 'Daerah', key: 'd', width: 15 },
                { header: 'Lokasi', key: 'l', width: 22 },
                { header: 'Koordinat', key: 'c', width: 22 },
                { header: 'Kategori', key: 'kt', width: 18 },       // <--- 7. Kategori (Merge)
                { header: 'Tanaman', key: 'tn', width: 18 },        // <--- 8. Tanaman (Merge)
                { header: 'Luas Bancian (Ha)', key: 'lt', width: 18 }, // <--- 9. Luas Bancian (Merge)
                { header: 'Syor Kawalan', key: 's', width: 25 },            // <--- 10. Syor (Merge)
                { header: 'Pegawai Yang Mengisi Data', key: 'pg', width: 20 },        // <--- 11. Pegawai (Merge)
                
                // --- PEMISAH ZON MERGE ---
                
                { header: 'Nama Perosak', key: 'p', width: 20 },         // <--- 12. Perosak
                { header: 'Keterukan Serangan', key: 'k', width: 18 },            // <--- 13. Tahap
                { header: 'Luas Serangan (Ha)', key: 'ls', width: 18 }, // <--- 14. Luas Serangan
                { header: '% Serangan', key: 'pct', width: 15 }     // <--- 15. Peratus (Baru)
            ];

            // Style Header
            worksheet.getRow(1).font = { bold: true };
            worksheet.getRow(1).alignment = { vertical: 'middle', horizontal: 'center' };
            worksheet.getRow(1).eachCell((cell) => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } };
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
            });

            let rowIndex = 2;

            fData.forEach(d => {
                let pestEntries = (d.p && Object.keys(d.p).length > 0) ? Object.entries(d.p) : [["TIADA", 0]];
                let startRow = rowIndex;
                let luasTanam = parseFloat(d.lt) || 0;

                pestEntries.forEach(([pName, pArea]) => {
                    let luasSerang = parseFloat(pArea) || 0;
                    
                    // Kira Peratus: (Luas Serang / Luas Tanam) * 100
                    let pctVal = (luasTanam > 0) ? ((luasSerang / luasTanam) * 100).toFixed(2) + '%' : "0%";

                    const row = worksheet.getRow(rowIndex);
                    row.values = {
                        id: d.id,
                        t: d.t,
                        n: d.n,
                        d: d.d,
                        l: d.l,
                        c: d.c || "-",
                        kt: d.kt || "-",    // Kategori
                        tn: d.tn,
                        lt: luasTanam,
                        s: d.s,
                        pg: d.pg || "-",    // Pegawai
                        p: pName,
                        k: d.k,
                        ls: luasSerang,
                        pct: pctVal         // Nilai Peratus
                    };
                    
                    // Border
                    row.eachCell({ includeEmpty: true }, (cell) => {
                        cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                    });
                    
                    rowIndex++;
                });

                // 2. LOGIK MERGE (Kolum 1 hingga 11)
                // Kita merge semua info statik termasuk Pegawai
                if (pestEntries.length > 1) {
                    let endRow = rowIndex - 1;
                    for (let c = 1; c <= 11; c++) {
                        worksheet.mergeCells(startRow, c, endRow, c);
                    }
                }

                // 3. LOGIK ALIGNMENT
                for (let r = startRow; r < rowIndex; r++) {
                    // Kumpulan Statik (Kiri: Kolum 1-11) -> Center
                    for (let c = 1; c <= 11; c++) { 
                        worksheet.getCell(r, c).alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                    }
                    
                    // Kumpulan Dinamik (Kanan: Kolum 12-15)
                    worksheet.getCell(r, 12).alignment = { vertical: 'middle', horizontal: 'left' };   // Perosak
                    worksheet.getCell(r, 13).alignment = { vertical: 'middle', horizontal: 'center' }; // Tahap
                    worksheet.getCell(r, 14).alignment = { vertical: 'middle', horizontal: 'center' }; // Luas S
                    worksheet.getCell(r, 15).alignment = { vertical: 'middle', horizontal: 'center' }; // Peratus
                }
            });

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = 'PNR_Laporan_Lengkap.xlsx';
            anchor.click();
            window.URL.revokeObjectURL(url);
        }
        
        async function dlPDF() {
    const btn = document.querySelector('button[onclick="dlPDF()"]');
    btn.innerHTML = "Jana..."; 
    btn.disabled = true;

    // --- 1. MULA LOGIK KIRA TARIKH ---
    let dateLabel = "Terkini";
    
    // Pastikan fData wujud dan ada isi
    if (typeof fData !== 'undefined' && fData.length > 0) {
        // Ambil list tarikh dan susun ikut turutan
        const sortedDates = fData.map(d => d.t).sort();
        
        // Fungsi kecil untuk tukar YYYY-MM-DD jadi DD/MM/YYYY
        const fmt = (d) => d.split('-').reverse().join('/');
        
        const first = fmt(sortedDates[0]); // Tarikh Awal
        const last = fmt(sortedDates[sortedDates.length - 1]); // Tarikh Akhir
        
        // Kalau tarikh mula & akhir sama, tunjuk satu je. Kalau beza, tunjuk range.
        dateLabel = (first === last) ? first : `${first} Hingga ${last}`;
    }
    // --- TAMAT LOGIK KIRA TARIKH ---

    try {
        // Masukkan 'dateLabel' ke dalam object 'meta'
        const m = {
            user: uProf.name, 
            negeri: document.getElementById('selNegeri').value || "Semua", 
            dates: dateLabel // <--- GUNA VARIABLE BARU TADI
        };
        
        const r = await postData('genPDF', {data: fData, meta: m});
        
        if(r.success) {
            const a = document.createElement('a'); 
            a.href = "data:application/pdf;base64," + r.base64; 
            a.download = r.filename; 
            a.click();
        } else {
            alert("Gagal PDF");
        }
    } catch(e) { 
        console.error(e); // Bagus untuk debug
        alert("Error PDF"); 
    }
    
    btn.innerHTML = '<i class="bi bi-file-earmark-pdf"></i> PDF'; 
    btn.disabled = false;
}

        async function loadPend() {
            const tb = document.getElementById('vBody'), th = document.getElementById('vHead');
            tb.innerHTML = '<tr><td colspan="100%" class="text-center p-5"><span class="spinner-border"></span></td></tr>'; th.innerHTML='';
            try {
                const d = await postData('getPending', {state: uProf.state});
                if(!d.rows || !d.rows.length) { tb.innerHTML='<tr><td colspan="100%" class="text-center p-5 text-muted">Tiada data baru.</td></tr>'; return; }
                let h = '<th>#</th>'; d.headers.forEach(x => h+=`<th>${x}</th>`); h+='<th>Tindakan</th>';
                th.innerHTML = h;
                tb.innerHTML = d.rows.map((r,i) => {
                    let tds = `<td>${i+1}</td>` + r.data.map(c=>`<td>${c}</td>`).join('');
                    return `<tr>${tds}<td><button class="btn btn-sm btn-success me-1" onclick="subVer(${r.row},'APPROVE')">✔</button><button class="btn btn-sm btn-danger" onclick="subVer(${r.row},'REJECT')">✘</button></td></tr>`;
                }).join('');
            } catch(e) { tb.innerHTML='<tr><td colspan="100%" class="text-danger text-center">Ralat</td></tr>'; }
        }

        async function subVer(row, act) {
            let re = ""; if(act==='REJECT'){ re=prompt("Sebab:"); if(!re) return; } else if(!confirm("Sahkan?")) return;
            const r = await postData('submitVerify', {row:row, act:act, reason:re, name:uProf.name});
            alert(r.message); if(r.success) { loadPend(); checkPendingCount(); initDash(); }
        }
    </script>
</body>
</html>
