<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PNR Pro Dashboard</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    :root { --primary: #064e3b; --accent: #10b981; --bg: #f8fafc; }
    body { background: var(--bg); font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; overflow-x: hidden; }
    
    #loginOverlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .sidebar { width: 250px; position: fixed; top: 0; bottom: 0; background: white; border-right: 1px solid #e2e8f0; z-index: 100; padding: 20px; display:flex; flex-direction:column; transition:0.3s; }
    .main-content { margin-left: 250px; padding: 25px; transition:0.3s; }
    
    .stat-card { background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid var(--accent); }
    .chart-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
    #map { height: 400px; border-radius: 10px; width: 100%; z-index: 1; }
    
    .nav-link { cursor: pointer; padding: 10px; border-radius: 8px; color: #64748b; margin-bottom: 5px; font-weight: 500; }
    .nav-link.active, .nav-link:hover { background: #f1f5f9; color: var(--primary); }
    
    @media(max-width:768px){ .sidebar{transform:translateX(-100%)} .main-content{margin-left:0} .sidebar.active{transform:translateX(0)} }
  </style>
</head>
<body>

  <script>
    // ⚠️ GANTI URL API ANDA
    const API_URL = "https://script.google.com/macros/s/AKfycbzu_29jZu-cG7_y-_mq_Pk6iJiFx5tPht71KK-2k_8xV-SDiv3olWqY05ZdiVWJbFP-/exec"; 
    // ⚠️ GANTI URL BORANG BANCIAN
    const BANCIAN_URL = "https://script.google.com/macros/s/AKfycbysNeegvBM-m16DFLHEM-imbcduU5LZG0G3OipMd9YNgrXWYdNCWj9Yu7NnzbvMAyErDw/exec"; 

    let mData=[], fData=[], uProf=null, charts={}, map=null, layer=null, pg=1, pSize=10;
    let sessionID = null; 

    // --- UTILS ---
    async function postData(action, payload) {
      try {
        const res = await fetch(`${API_URL}?action=${action}`, { 
          method: "POST", 
          body: JSON.stringify({...payload, action: action}) 
        });
        const text = await res.text();
        return JSON.parse(text);
      } catch (e) { 
        console.error(e);
        alert("Ralat sambungan server!"); 
        throw e; 
      }
    }

    // --- 1. LOGIN & SYSTEM ---
    async function doLogin(){
      const u=document.getElementById('uid').value;
      const p=document.getElementById('pwd').value;
      const b=document.getElementById('btnLogin');
      const msg=document.getElementById('loginMsg');
      
      if(!u || !p) { msg.innerText="Sila isi ID dan Kata Laluan."; return; }
      
      b.disabled=true; b.innerText="Sedang Proses...";
      msg.innerText = "";

      try {
        const r = await postData('login', {u, p});
        
        if(r.success){ 
          uProf=r; 
          sessionID=r.sid; 
          
          // Update UI
          document.getElementById('uDisp').innerText=r.name; 
          document.getElementById('loginOverlay').style.display='none'; 
          
          // Role Based Access
          if(["ADMIN","PENYELIA"].includes((r.role||"").toUpperCase())) {
             document.getElementById('navVerify').style.display="block";
             checkPendingCount();
          }
          
          // Init Dashboard
          initDash();
          
          // Start Heartbeat (Setiap 15 Minit - 900,000ms) - MODE SELAMAT
          setInterval(() => { postData('heartbeat', {sid: sessionID}); }, 900000); 

        } else { 
          msg.innerText=r.message; 
          b.disabled=false; 
          b.innerText="LOG MASUK"; 
        }
      } catch(e) { 
        msg.innerText="Ralat sistem. Sila cuba lagi."; 
        b.disabled=false; 
        b.innerText="LOG MASUK"; 
      }
    }

    // --- 2. NAVIGATION & TABS ---
    function switchTab(tab, el){
        // Reset Active Class
        document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
        if(el) el.classList.add('active');

        // Hide All Views
        document.getElementById('view-main').style.display = 'none';
        document.getElementById('view-verify').style.display = 'none';

        // Show Selected View
        if(tab === 'main'){
            document.getElementById('view-main').style.display = 'block';
        } else if (tab === 'verify'){
            document.getElementById('view-verify').style.display = 'block';
            loadPend(); // Auto load data bila tab dibuka
        }
    }

    async function checkPendingCount(){
        try {
            const d = await postData('getPending', {state: uProf.state});
            const badge = document.getElementById('badgePending');
            if(d.rows && d.rows.length > 0){
                badge.innerText = d.rows.length;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        } catch(e){}
    }

    // --- 3. DASHBOARD LOGIC ---
    async function initDash(){
      try {
        const d = await postData('getAnalytics', { state: uProf.state });
        mData = d.records;
        
        // Setup Filters
        fillSel('selNegeri', d.filters.negeri); 
        fillSel('selTanaman', d.filters.tanaman); 
        fillSel('selKategori', d.filters.kategori);
        
        // Lock Negeri kalau bukan Admin Pusat
        if(uProf.state !== "ALL"){ 
            const selN = document.getElementById('selNegeri');
            selN.value = uProf.state; 
            selN.disabled = true; 
        }
        
        // Init Map
        if(!map){ 
            map = L.map('map').setView([4.2105,101.9758], 6); 
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map); 
        }
        
        runFilter();
      } catch(e) { console.error("Dash Error", e); }
    }

    function runFilter(){
      const n=document.getElementById('selNegeri').value;
      const t=document.getElementById('selTanaman').value;
      const k=document.getElementById('selKategori').value;
      const s=document.getElementById('dS').value;
      const e=document.getElementById('dE').value;

      fData = mData.filter(d => {
        let ok = (n===""||d.n===n) && (t===""||d.tn===t) && (k===""||d.kt===k);
        if(s && d.t<s) ok=false; 
        if(e && d.t>e) ok=false; 
        return ok;
      });
      
      pg=1; 
      calcUI();
    }

    function calcUI(){
      let tt=0, ts=0, pm={}, km={1:0,2:0,3:0,4:0,5:0}, pts=[];
      let hotspotData = {}; 

      fData.forEach(d=>{
        tt+=d.lt; ts+=d.ls;
        // Parsing Pest JSON
        if(d.p) Object.entries(d.p).forEach(([k,v])=>{ pm[k]=(pm[k]||0)+parseFloat(v); });
        // Tahap Keterukan
        if(d.k>0) km[d.k]++;
        // Map Points
        if(d.c && d.c.includes(',')) pts.push(d.c.split(',').map(Number));
        // Hotspot Daerah
        if(d.ls > 0 && d.d !== "-") hotspotData[d.d] = (hotspotData[d.d]||0) + d.ls;
      });

      // Update KPI Cards
      document.getElementById('k1').innerText = tt.toFixed(2); 
      document.getElementById('k2').innerText = ts.toFixed(2);
      document.getElementById('k3').innerText = tt>0 ? ((ts/tt)*100).toFixed(2)+"%" : "0%"; 
      document.getElementById('k4').innerText = fData.length;
      
      upChart(pm,km);
      genSummary(pm, km, tt, ts); 
      genHotspot(hotspotData); 
      
      // Update Map
      if(layer) map.removeLayer(layer); 
      if(pts.length) {
          layer = L.layerGroup(pts.map(p => L.circleMarker(p, {
              radius: 5, color: '#dc2626', fillOpacity: 0.7, stroke: false
          }))).addTo(map);
      }
      renTab();
    }

    function renTab(){
      const st=(pg-1)*pSize;
      const dt=fData.slice(st,st+pSize);
      const tbody = document.getElementById('tBody');
      
      if(dt.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Tiada Rekod</td></tr>';
      } else {
          tbody.innerHTML = dt.map(d=>`
            <tr>
                <td>${d.t}</td>
                <td>${d.n}</td>
                <td>${d.l}</td>
                <td><span class="badge bg-light text-dark border">${d.tn}</span></td>
                <td>${d.lt.toFixed(2)}</td>
                <td class="text-danger fw-bold">${d.ls.toFixed(2)}</td>
            </tr>`).join('');
      }
      document.getElementById('pgInfo').innerText=`Halaman ${pg} / ${Math.ceil(fData.length/pSize) || 1}`;
    }

    function movePg(d){ 
        const maxPg = Math.ceil(fData.length/pSize) || 1;
        pg = Math.max(1, Math.min(maxPg, pg+d)); 
        renTab(); 
    }

    function fillSel(i,a){ 
        const e=document.getElementById(i); 
        e.innerHTML='<option value="">Semua</option>'; 
        a.forEach(x=>{if(x)e.innerHTML+=`<option value="${x}">${x}</option>`}); 
    }

    // --- 4. CHARTS & SUMMARY ---
    function upChart(p,k){
      // Bar Chart (Top 10 Pest)
      const tp=Object.entries(p).sort((a,b)=>b[1]-a[1]).slice(0,10);
      
      if(charts.b) charts.b.destroy(); 
      charts.b = new Chart(document.getElementById('cBar'), {
          type: 'bar',
          data: {
              labels: tp.map(x=>x[0]),
              datasets: [{
                  label: 'Luas Serangan (Ha)',
                  data: tp.map(x=>x[1]),
                  backgroundColor: '#10b981',
                  borderRadius: 5
              }]
          },
          options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: {display: false} } }
      });

      // Pie Chart (Keterukan)
      if(charts.p) charts.p.destroy(); 
      charts.p = new Chart(document.getElementById('cPie'), {
          type: 'doughnut',
          data: {
              labels: ['Tahap 1','Tahap 2','Tahap 3','Tahap 4','Tahap 5'],
              datasets: [{
                  data: [km[1]||0, km[2]||0, km[3]||0, km[4]||0, km[5]||0],
                  backgroundColor: ['#22c55e','#84cc16','#eab308','#f97316','#ef4444'],
                  borderWidth: 0
              }]
          },
          options: { maintainAspectRatio: false, plugins: { legend: {position:'right'} } }
      });
    }

    function genSummary(pm, km, tt, ts){
       const el = document.getElementById('smartSummary');
       if(!fData.length){ el.innerHTML="Tiada data untuk dianalisis."; return;}
       
       let topP="-", topV=0; 
       Object.entries(pm).forEach(([k,v])=>{if(v>topV){topP=k; topV=v}});
       
       const percent = tt > 0 ? ((ts/tt)*100).toFixed(1) : 0;
       
       el.innerHTML = `
        <div class="d-flex align-items-center gap-3">
            <div class="flex-fill border-end pe-3">
                <small class="text-muted d-block">MUSUH UTAMA</small>
                <strong class="text-dark">${topP}</strong> 
                <span class="badge bg-warning text-dark">${topV.toFixed(2)} Ha</span>
            </div>
            <div class="flex-fill">
                <small class="text-muted d-block">STATUS KESELURUHAN</small>
                <strong class="${percent > 10 ? 'text-danger':'text-success'}">
                    ${percent}% Serangan
                </strong>
                <small>dari ${tt.toFixed(2)} Ha</small>
            </div>
        </div>`;
    }

    function genHotspot(hData){
       const sorted = Object.entries(hData).sort((a,b)=>b[1]-a[1]).slice(0,5);
       const el = document.getElementById('hotspotTable');
       if(!sorted.length) { el.innerHTML='<tr><td colspan="2" class="text-center text-muted p-3">Tiada Hotspot Dikesan</td></tr>'; return; }
       
       el.innerHTML = sorted.map((x, i)=>`
        <tr>
            <td><span class="badge bg-secondary me-2">${i+1}</span>${x[0]}</td>
            <td class="text-end fw-bold text-danger">${x[1].toFixed(2)}</td>
        </tr>`).join('');
    }

    // --- 5. EXCEL & PDF ---
    function downloadDualExcel(){
      if(!fData.length) { alert("Tiada data untuk dimuat turun!"); return; }
      
      const masterData = fData.map(d => ({
        "ID_RUJUKAN": d.id, "TARIKH": d.t, "NEGERI": d.n, "DAERAH": d.d, 
        "LOKASI": d.l, "TANAMAN": d.tn, "LUAS_BANCIAN_HA": d.lt, "SYOR": d.s
      }));

      let detailData = [];
      fData.forEach(d => {
        if(d.p && Object.keys(d.p).length > 0){
          Object.entries(d.p).forEach(([pest, area]) => {
            detailData.push({ "ID_RUJUKAN": d.id, "JENIS_PEROSAK": pest, "LUAS_SERANG_HA": parseFloat(area), "TAHAP": d.k });
          });
        } else {
           detailData.push({ "ID_RUJUKAN": d.id, "JENIS_PEROSAK": "TIADA", "LUAS_SERANG_HA": 0, "TAHAP": 0 });
        }
      });

      const wb = XLSX.utils.book_new();
      const ws1 = XLSX.utils.json_to_sheet(masterData);
      const ws2 = XLSX.utils.json_to_sheet(detailData);
      
      XLSX.utils.book_append_sheet(wb, ws1, "MAKLUMAT_UTAMA");
      XLSX.utils.book_append_sheet(wb, ws2, "PERINCIAN_PEROSAK");
      XLSX.writeFile(wb, "PNR_Laporan_Lengkap.xlsx");
    }

    async function dlPDF(){
       const btn = document.querySelector('button[onclick="dlPDF()"]'); 
       const oldTxt = btn.innerHTML;
       btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Jana...';
       btn.disabled = true;

       const meta={ 
           user: uProf.name, 
           negeri: document.getElementById('selNegeri').value || "Semua", 
           dates: `${document.getElementById('dS').value || 'Mula'} - ${document.getElementById('dE').value || 'Tamat'}` 
       };
       
       try { 
            const r = await postData('genPDF', {data: fData, meta: meta}); 
            if(r.success){
                const a = document.createElement('a'); 
                a.href = "data:application/pdf;base64," + r.base64; 
                a.download = r.filename; 
                a.click(); 
            } else {
                alert("Gagal menjana PDF.");
            }
       } catch(e){ 
           alert("Ralat server PDF."); 
       } 
       
       btn.innerHTML = oldTxt;
       btn.disabled = false;
    }

    // --- 6. PENGESAHAN DATA (VERIFY) ---
    async function loadPend(){
       const tHead = document.getElementById('vHead');
       const tBody = document.getElementById('vBody');
       
       tBody.innerHTML = '<tr><td colspan="100%" class="text-center p-5"><div class="spinner-border text-primary"></div><br>Memuat turun data...</td></tr>';
       tHead.innerHTML = ''; // Clear header dulu

       try {
           const d = await postData('getPending', {state: uProf.state});
           
           if(!d || !d.rows || d.rows.length === 0){
               tBody.innerHTML = '<tr><td colspan="100%" class="text-center p-5 text-muted"><h5>Tiada Data Baru</h5><p>Semua data telah disahkan.</p></td></tr>';
               return;
           }

           // Render Header
           let hHtml = '<th>#</th>';
           d.headers.forEach(h => hHtml += `<th>${h}</th>`);
           hHtml += '<th class="text-center" style="width:120px">Tindakan</th>';
           tHead.innerHTML = hHtml;

           // Render Rows
           tBody.innerHTML = d.rows.map((r, i) => {
               let tds = `<td>${i+1}</td>` + r.data.map(c => `<td>${c}</td>`).join('');
               tds += `
                <td class="text-center">
                    <button class="btn btn-sm btn-success me-1" title="Sahkan" onclick="subVer(${r.row}, 'APPROVE')">
                        <i class="bi bi-check-lg"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" title="Tolak" onclick="subVer(${r.row}, 'REJECT')">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </td>`;
               return `<tr>${tds}</tr>`;
           }).join('');

       } catch(e) {
           tBody.innerHTML = `<tr><td colspan="100%" class="text-center text-danger p-4">Ralat: ${e.message}</td></tr>`;
       }
    }

    async function subVer(row, act){
      let reason = "";
      
      if(act === 'REJECT'){ 
          reason = prompt("Sila nyatakan sebab penolakan (Wajib):"); 
          if(!reason) return; // Kalau cancel atau kosong, batalkan
      } else { 
          if(!confirm("Adakah anda pasti untuk SAHKAN data ini?")) return; 
      }
      
      // UI Loading State (Optional: boleh tambah spinner pada button jika mahu)
      
      try {
          const r = await postData('submitVerify', {
              row: row, 
              act: act, 
              reason: reason, 
              name: uProf.name
          });
          
          if(r.success){
              alert(r.message);
              loadPend();        // Refresh table verify
              checkPendingCount(); // Refresh badge count
              initDash();        // Refresh dashboard data juga jika perlu
          } else {
              alert("Gagal: " + r.message);
          }
      } catch(e) {
          alert("Ralat semasa menghantar pengesahan.");
      }
    }

</script>
 
