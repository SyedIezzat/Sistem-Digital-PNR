<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PNR Pro Dashboard</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    :root { --primary: #064e3b; --accent: #10b981; --bg: #f8fafc; }
    body { background: var(--bg); font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; overflow-x: hidden; }
    
    /* LOGIN */
    #loginOverlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    
    /* LAYOUT */
    .sidebar { width: 250px; position: fixed; top: 0; bottom: 0; background: white; border-right: 1px solid #e2e8f0; z-index: 100; padding: 20px; display:flex; flex-direction:column; transition:0.3s; }
    .main-content { margin-left: 250px; padding: 25px; transition:0.3s; }
    
    /* WIDGETS */
    .stat-card { background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid var(--accent); }
    .chart-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
    #map { height: 400px; border-radius: 10px; width: 100%; z-index: 1; }
    
    /* NAV */
    .nav-link { cursor: pointer; padding: 10px; border-radius: 8px; color: #64748b; margin-bottom: 5px; font-weight: 500; display: flex; align-items: center; justify-content: space-between; }
    .nav-link:hover { background: #f1f5f9; color: var(--primary); }
    .nav-link.active { background: #e0f2fe; color: var(--primary); font-weight: bold; }
    
    /* LOADING SPINNER */
    .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 50; display: none; }

    @media(max-width:768px){ .sidebar{transform:translateX(-100%)} .main-content{margin-left:0} .sidebar.active{transform:translateX(0)} }
  </style>
</head>
<body>
<script>
    // --- 1. CONFIGURATION ---
    // ⚠️ PASTE URL WEB APP ANDA DI SINI
    const API_URL = "https://script.google.com/macros/s/AKfycbybYfIRU52AkFgk2wRXguK5Ja9DAjDkbwEy-zG3B8goc1c7UvbrrDhDli4hULaTJ1s/exec"; 
    
    // ⚠️ PASTE URL BORANG ANDA
    const BANCIAN_URL = "https://script.google.com/macros/s/AKfycbysNeegvBM-m16DFLHEM-imbcduU5LZG0G3OipMd9YNgrXWYdNCWj9Yu7NnzbvMAyErDw/exec"; 

    // --- 2. GLOBAL VARIABLES ---
    let mData = [], fData = [], uProf = null;
    let charts = {}, map = null, layer = null;
    let pg = 1, pSize = 10, sessionID = null;

    // --- 3. UTILITY FUNCTIONS ---
    async function postData(action, payload) {
        try {
            const res = await fetch(`${API_URL}?action=${action}`, { 
                method: "POST", 
                body: JSON.stringify({...payload, action: action}) 
            });
            const text = await res.text();
            return JSON.parse(text);
        } catch (e) { 
            console.error("Connection Error:", e); 
            return {success: false, message: "Gagal menyambung ke server."}; 
        }
    }

    // --- 4. AUTHENTICATION ---
    async function doLogin(){
        const u = document.getElementById('uid').value;
        const p = document.getElementById('pwd').value;
        const btn = document.getElementById('btnLogin');
        const msg = document.getElementById('loginMsg');
        
        if(!u || !p) { 
            msg.innerText = "Sila isi ID & Kata Laluan."; 
            return; 
        }

        btn.disabled = true; 
        btn.innerText = "Memproses..."; 
        msg.innerText = "";
        
        const r = await postData('login', {u, p});
        
        if(r.success){ 
            uProf = r; 
            sessionID = r.sid;
            
            // UI Update
            document.getElementById('uDisp').innerText = r.name; 
            document.getElementById('loginOverlay').style.display = 'none'; 
            
            // Check Role for Verify Tab
            if(["ADMIN","PENYELIA"].includes((r.role||"").toUpperCase())) {
                document.getElementById('navVerify').style.display = "flex"; 
                checkPendingCount(); 
            }
            
            // Start App
            initDash(); 
            
            // Heartbeat
            setInterval(() => { 
                postData('heartbeat', {sid: sessionID}); 
            }, 900000); // 15 Minit

        } else { 
            msg.innerText = r.message; 
            btn.disabled = false; 
            btn.innerText = "LOG MASUK"; 
        }
    }

    // --- 5. NAVIGATION ---
    function switchTab(tab, el){
        document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
        if(el) el.classList.add('active');

        document.getElementById('view-main').style.display = (tab === 'main') ? 'block' : 'none';
        document.getElementById('view-verify').style.display = (tab === 'verify') ? 'block' : 'none';

        if(tab === 'verify') loadPend();
        
        // Fix Map Glitch
        if(tab === 'main' && map) {
            setTimeout(() => { map.invalidateSize(); }, 200);
        }
    }

    async function checkPendingCount(){
        try {
            const d = await postData('getPending', {state: uProf.state});
            const badge = document.getElementById('badgePending');
            if(d.rows && d.rows.length > 0){ 
                badge.innerText = d.rows.length; 
                badge.style.display = 'inline'; 
            } else { 
                badge.style.display = 'none'; 
            }
        } catch(e){}
    }

    // --- 6. DASHBOARD CORE ---
    async function initDash(){
        document.getElementById('loadChart').style.display = 'flex';
        
        const d = await postData('getAnalytics', { state: uProf.state });
        document.getElementById('loadChart').style.display = 'none';

        if(!d.records) { 
            console.error("Data Error", d);
            return; 
        }
        
        mData = d.records;
        
        // Setup Filters
        fillSel('selNegeri', d.filters.negeri); 
        fillSel('selTanaman', d.filters.tanaman); 
        fillSel('selKategori', d.filters.kategori);
        
        if(uProf.state !== "ALL"){ 
            const selN = document.getElementById('selNegeri');
            selN.value = uProf.state; 
            selN.disabled = true; 
        }
        
        // Setup Map
        if(!map){ 
            map = L.map('map').setView([4.2105, 101.9758], 6); 
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map); 
        }
        
        runFilter();
    }

    function fillSel(id, arr){ 
        const el = document.getElementById(id); 
        el.innerHTML = '<option value="">Semua</option>'; 
        if(arr) arr.forEach(x => {
            if(x) el.innerHTML += `<option value="${x}">${x}</option>`;
        }); 
    }

    function runFilter(){
        const n = document.getElementById('selNegeri').value;
        const t = document.getElementById('selTanaman').value;
        const k = document.getElementById('selKategori').value;
        const s = document.getElementById('dS').value;
        const e = document.getElementById('dE').value;
        
        fData = mData.filter(d => {
            let ok = (n==="" || d.n===n) && (t==="" || d.tn===t) && (k==="" || d.kt===k);
            if(s && d.t < s) ok = false; 
            if(e && d.t > e) ok = false; 
            return ok;
        });
        
        pg = 1; 
        calcUI();
    }

    // --- 7. DATA PROCESSING & UI ---
    function calcUI(){
        try {
            let totalTanam = 0, totalSerang = 0;
            let pestMap = {}, levelMap = {1:0, 2:0, 3:0, 4:0, 5:0};
            let mapPoints = [], hotspotMap = {};
            
            fData.forEach(d => {
                totalTanam += (d.lt || 0); 
                totalSerang += (d.ls || 0);
                
                // Pest Aggregation
                if(d.p && Object.keys(d.p).length > 0){ 
                    Object.entries(d.p).forEach(([k,v]) => { 
                        pestMap[k] = (pestMap[k] || 0) + parseFloat(v); 
                    }); 
                } else if (d.ls > 0) { 
                    pestMap["Serangan Umum"] = (pestMap["Serangan Umum"] || 0) + d.ls; 
                }
                
                // Level Aggregation
                let l = parseInt(d.k) || 0; 
                if(l > 0 && l <= 5) levelMap[l]++;
                
                // Map Points
                if(d.c && typeof d.c === 'string' && d.c.includes(',')) {
                    let parts = d.c.split(',').map(n => parseFloat(n.trim()));
                    if(parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                        mapPoints.push(parts);
                    }
                }
                
                // Hotspot
                if(d.ls > 0 && d.d !== "-") {
                    hotspotMap[d.d] = (hotspotMap[d.d] || 0) + d.ls;
                }
            });
      
            // Update KPI
            document.getElementById('k1').innerText = totalTanam.toFixed(2); 
            document.getElementById('k2').innerText = totalSerang.toFixed(2);
            document.getElementById('k3').innerText = totalTanam > 0 ? ((totalSerang/totalTanam)*100).toFixed(1) + "%" : "0%"; 
            document.getElementById('k4').innerText = fData.length;
            
            // Visuals
            updateCharts(pestMap, levelMap); 
            updateSummary(pestMap, totalTanam, totalSerang); 
            updateHotspot(hotspotMap);
            updateMap(mapPoints);
            
            renderTable(); 
            
        } catch(e) { console.error("UI Calc Error:", e); }
    }

    // --- 8. CHART RENDER ---
    function updateCharts(pMap, kMap){
        // Bar Chart
        const topPests = Object.entries(pMap).sort((a,b) => b[1]-a[1]).slice(0,10);
        const labels = topPests.length ? topPests.map(x=>x[0]) : ['Tiada Data'];
        const values = topPests.length ? topPests.map(x=>x[1]) : [0];

        if(charts.b) charts.b.destroy(); 
        charts.b = new Chart(document.getElementById('cBar'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Luas Serangan (Ha)',
                    data: values,
                    backgroundColor: '#10b981',
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                maintainAspectRatio: false,
                plugins: { legend: {display: false} }
            }
        });
        
        // Pie Chart
        if(charts.p) charts.p.destroy(); 
        charts.p = new Chart(document.getElementById('cPie'), {
            type: 'doughnut',
            data: {
                labels: ['Tahap 1','Tahap 2','Tahap 3','Tahap 4','Tahap 5'],
                datasets: [{
                    data: Object.values(kMap),
                    backgroundColor: ['#22c55e','#84cc16','#eab308','#f97316','#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: {position:'right'} }
            }
        });
    }

    function updateMap(pts){
        if(layer) map.removeLayer(layer); 
        if(pts.length > 0) {
            layer = L.layerGroup(pts.map(p => L.circleMarker(p, {
                radius: 6, color: '#dc2626', fillOpacity: 0.6, stroke: false
            }))).addTo(map);
            
            // Auto Zoom
            const bounds = L.latLngBounds(pts);
            map.fitBounds(bounds);
        }
    }

    function updateSummary(pm, tt, ts){
       const el = document.getElementById('smartSummary');
       let topP = "-", topV = 0; 
       
       Object.entries(pm).forEach(([k,v]) => {
           if(v > topV){ topP = k; topV = v; }
       });
       
       if(topP === "-" && ts > 0) { topP = "Serangan Umum"; topV = ts; }
       const pct = tt > 0 ? ((ts/tt)*100).toFixed(1) : 0;
       
       el.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <small class="text-secondary">MUSUH UTAMA</small><br>
                <b class="text-dark">${topP}</b> <span class="badge bg-warning text-dark">${topV.toFixed(2)} Ha</span>
            </div>
            <div class="text-end">
                <small class="text-secondary">INDEKS KESELURUHAN</small><br>
                <b class="${pct > 10 ? 'text-danger':'text-success'} fs-5">${pct}%</b>
            </div>
        </div>`;
    }

    function updateHotspot(hData){
       const s = Object.entries(hData).sort((a,b) => b[1]-a[1]).slice(0,5);
       const tb = document.getElementById('hotspotTable');
       
       if(s.length === 0) {
           tb.innerHTML = '<tr><td colspan="2" class="text-center text-muted p-2">Tiada Hotspot</td></tr>';
       } else {
           tb.innerHTML = s.map((x,i) => `
            <tr>
                <td><span class="badge bg-light text-dark border me-2">${i+1}</span>${x[0]}</td>
                <td class="text-end fw-bold text-danger">${x[1].toFixed(2)}</td>
            </tr>`).join('');
       }
    }

    // --- 9. TABLE RENDER ---
    function renderTable(){
      const start = (pg-1) * pSize;
      const dataSlice = fData.slice(start, start + pSize);
      const tb = document.getElementById('tBody');
      const info = document.getElementById('pgInfo');
      
      if(!dataSlice.length) { 
          tb.innerHTML = '<tr><td colspan="6" class="text-center text-muted p-3">Tiada rekod dijumpai</td></tr>'; 
          info.innerText = "";
          return; 
      }
      
      tb.innerHTML = dataSlice.map(d => `
        <tr>
            <td>${d.t || '-'}</td>
            <td>${d.n || '-'}</td>
            <td>${d.l || '-'}</td>
            <td><span class="badge bg-white text-dark border">${d.tn || '-'}</span></td>
            <td>${(d.lt || 0).toFixed(2)}</td>
            <td class="text-danger fw-bold">${(d.ls || 0).toFixed(2)}</td>
        </tr>`).join('');
        
      const maxPage = Math.ceil(fData.length/pSize) || 1;
      info.innerText = `Halaman ${pg} / ${maxPage}`;
    }
    
    function movePg(d){ 
        const maxPage = Math.ceil(fData.length/pSize) || 1;
        pg = Math.max(1, Math.min(maxPage, pg + d)); 
        renderTable(); 
    }

    // --- 10. EXPORTS ---
    function downloadDualExcel(){
      if(!fData.length) { alert("Tiada data!"); return; }
      
      const md = fData.map(d => ({
          "ID": d.id, "TARIKH": d.t, "NEGERI": d.n, "DAERAH": d.d, 
          "LOKASI": d.l, "TANAMAN": d.tn, "LUAS_BANCIAN": d.lt, "SYOR": d.s
      }));
      
      let dd = [];
      fData.forEach(d => {
        if(d.p && Object.keys(d.p).length){ 
            Object.entries(d.p).forEach(([p, a]) => {
                dd.push({"ID": d.id, "PEROSAK": p, "LUAS": parseFloat(a), "TAHAP": d.k});
            }); 
        } else { 
            dd.push({"ID": d.id, "PEROSAK": "TIADA", "LUAS": 0, "TAHAP": 0}); 
        }
      });
      
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(md), "SENARAI_UTAMA");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dd), "PERINCIAN_PEROSAK");
      XLSX.writeFile(wb, "PNR_Laporan_Lengkap.xlsx");
    }

    async function dlPDF(){
       const btn = document.querySelector('button[onclick="dlPDF()"]'); 
       const originalText = btn.innerHTML;
       btn.disabled = true; 
       btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Jana...';
       
       const meta = { 
           user: uProf.name, 
           negeri: document.getElementById('selNegeri').value || "Semua", 
           dates: `${document.getElementById('dS').value || 'Mula'} - ${document.getElementById('dE').value || 'Tamat'}` 
       };
       
       try { 
           const r = await postData('genPDF', {data: fData, meta: meta}); 
           if(r.success) { 
               const a = document.createElement('a'); 
               a.href = "data:application/pdf;base64," + r.base64; 
               a.download = r.filename; 
               a.click(); 
           } else { 
               alert("Gagal menjana PDF. Sila cuba lagi."); 
           }
       } catch(e){ 
           console.error(e); 
           alert("Ralat Sistem PDF."); 
       } 
       
       btn.disabled = false; 
       btn.innerHTML = originalText;
    }

    // --- 11. VERIFICATION MODULE ---
    async function loadPend(){
       const tb = document.getElementById('vBody');
       const th = document.getElementById('vHead');
       
       tb.innerHTML = '<tr><td colspan="100%" class="text-center p-5"><span class="spinner-border text-primary"></span></td></tr>';
       th.innerHTML = '';
       
       try {
           const d = await postData('getPending', {state: uProf.state});
           
           if(!d.rows || d.rows.length === 0){ 
               tb.innerHTML = '<tr><td colspan="100%" class="text-center p-5 text-muted">Tiada data baru untuk disahkan.</td></tr>'; 
               return; 
           }
           
           // Build Header
           let hHtml = '<th>#</th>'; 
           d.headers.forEach(h => hHtml += `<th>${h}</th>`); 
           hHtml += '<th class="text-center">Tindakan</th>';
           th.innerHTML = hHtml;
           
           // Build Rows
           tb.innerHTML = d.rows.map((r, i) => {
               let tds = `<td>${i+1}</td>` + r.data.map(c => `<td>${c}</td>`).join('');
               tds += `
                <td class="text-center">
                    <button class="btn btn-sm btn-success me-1" onclick="subVer(${r.row},'APPROVE')" title="Sahkan"><i class="bi bi-check-lg"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="subVer(${r.row},'REJECT')" title="Tolak"><i class="bi bi-x-lg"></i></button>
                </td>`;
               return `<tr>${tds}</tr>`;
           }).join('');
           
       } catch(e) { 
           tb.innerHTML = `<tr><td colspan="100%" class="text-danger text-center p-4">Ralat memuatkan data: ${e.message}</td></tr>`; 
       }
    }

    async function subVer(row, act){
      let reason = "";
      if(act === 'REJECT'){ 
          reason = prompt("Sila nyatakan sebab penolakan:"); 
          if(reason === null) return; // User cancel
      } else { 
          if(!confirm("Adakah anda pasti untuk SAHKAN data ini?")) return; 
      }
      
      try { 
          const r = await postData('submitVerify', {row: row, act: act, reason: reason, name: uProf.name}); 
          alert(r.message); 
          if(r.success) { 
              loadPend(); 
              checkPendingCount(); 
              initDash(); // Refresh main data juga
          } 
      } catch(e) { 
          alert("Ralat sambungan."); 
      }
    }
  </script>
