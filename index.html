<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard PNR</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#f8f9fa }
#loginOverlay {
  position:fixed; inset:0;
  background:#212529;
  display:flex;
  align-items:center;
  justify-content:center;
}
.login-box {
  background:#fff;
  padding:30px;
  border-radius:12px;
  width:100%;
  max-width:380px;
}
pre {
  background:#eee;
  padding:12px;
  max-height:400px;
  overflow:auto;
}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div id="loginOverlay">
  <div class="login-box text-center">
    <h4 class="mb-3">ðŸ”’ Login Dashboard</h4>

    <input id="usernameInput" class="form-control mb-2" placeholder="Username">
    <input id="passwordInput" type="password" class="form-control mb-3" placeholder="Password">

    <button class="btn btn-success w-100" onclick="attemptLogin()">
      Log Masuk
    </button>

    <div id="loginError" class="text-danger small mt-2"></div>
  </div>
</div>

<!-- ================= DASHBOARD ================= -->
<div id="dashboardWrapper" style="display:none">
  <nav class="navbar navbar-dark bg-success px-3">
    <span class="navbar-brand">ðŸŒ± Dashboard PNR</span>
    <span id="welcomeUser" class="text-white small"></span>
  </nav>

  <div class="container mt-4">
    <h5>ðŸ“Š Data dari Spreadsheet (TEST)</h5>
    <p class="text-muted">
      Jika data JSON muncul di bawah â†’ backend + frontend OK
    </p>

    <div id="dataContainer"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbxm90FJG-b5kkafVVU0urpCg_m7XAXrRsZW8LJlyM8l3VhPj5wJoqM2sckJmfb4BkbTsQ/exec"; // â— GANTI URL

let loggedInUser = null;

/* ================= LOGIN ================= */
function attemptLogin() {
  const u = usernameInput.value.trim();
  const p = passwordInput.value.trim();

  if (!u || !p) {
    loginError.innerText = "Sila isi username & password";
    return;
  }

  loginError.innerText = "Memeriksa...";

  fetch(`${WEBAPP_URL}?action=verifyUserLogin&username=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}`)
    .then(r => r.json())
    .then(res => {

      if (res.error) {
        loginError.innerText = res.message;
        return;
      }

      loggedInUser = res;

      document.getElementById("loginOverlay").style.display = "none";
      document.getElementById("dashboardWrapper").style.display = "block";

      document.getElementById("welcomeUser").innerText =
        `Selamat datang, ${res.name} (${res.role.toUpperCase()} - ${res.state})`;

      loadAnalisisData();
    })
    .catch(err => {
      console.error(err);
      loginError.innerText = "Ralat sambungan ke server";
    });
}

/* ================= LOAD DATA (CARA A) ================= */
function loadAnalisisData() {

  fetch(`${WEBAPP_URL}?action=getAllDashboardData&state=${encodeURIComponent(loggedInUser.state)}`)
    .then(r => r.json())
    .then(res => {

      console.log("RAW RESPONSE:", res);

      // ðŸ”‘ INI KUNCI UTAMA CARA A
      let data = res;
      if (typeof res === "string") {
        data = JSON.parse(res);
      }

      console.log("DATA SELEPAS PARSE:", data);

      if (!Array.isArray(data) || data.length === 0) {
        alert("Tiada data DISAHKAN dalam sistem");
        return;
      }

      renderData(data);
    })
    .catch(err => {
      console.error(err);
      alert("Ralat sambungan API");
    });
}

/* ================= RENDER (TEST) ================= */
function renderData(data) {
  document.getElementById("dataContainer").innerHTML = `
    <pre>${JSON.stringify(data, null, 2)}</pre>
  `;
}
</script>

</body>
</html>
